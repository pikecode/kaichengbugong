# 视频列表二维码生成方案

## 📋 文档信息

- **功能名称：** 视频列表二维码生成
- **设计日期：** 2026年2月6日
- **文档版本：** v1.0

---

## 🎯 需求背景

### 业务场景

用户希望通过扫描二维码，直接进入商品详情页的特定视频列表，无需手动选择日期和分类。

### 使用场景

1. **线下展示：** 在产品包装、宣传册上印刷二维码
2. **快速分享：** 通过二维码分享特定日期的溯源视频
3. **精准定位：** 直接跳转到指定分类的视频列表

---

## 📊 URL 参数设计

### 方案一：使用商品详情页（推荐）

**页面路径：** `/pages/goods/detail`

**URL 格式：**
```
/pages/goods/detail?id={商品ID}&date={日期}&type={分类}
```

**参数说明：**

| 参数 | 类型 | 必填 | 说明 | 示例 |
|------|------|------|------|------|
| id | Number | ✅ | 商品ID | 33 |
| date | String | ⬜ | 日期（YYYY-MM-DD） | 2024-10-15 |
| type | Number | ⬜ | 视频分类 | 0/1/2 |

**type 值说明：**
- `0`：商品溯源
- `1`：精彩瞬间
- `2`：多视角回放

**完整示例：**
```
/pages/goods/detail?id=33&date=2024-10-15&type=0
```

**效果：**
- 打开商品ID=33的详情页
- 自动选择日期：2024-10-15
- 自动切换到"商品溯源"分类
- 自动加载对应的视频列表

---

### 方案二：创建独立的视频列表页

**页面路径：** `/pages/video/list`（新建页面）

**URL 格式：**
```
/pages/video/list?goods_id={商品ID}&date={日期}&type={分类}
```

**优点：**
- 页面更简洁，只显示视频列表
- 加载速度更快
- 适合纯视频展示场景

**缺点：**
- 需要新建页面
- 无法查看商品详情

---

## 🎨 二维码生成位置

### 位置1：商品详情页（后台管理）

**文件：** `kcbg/application/admin/view/shop/goods/edit.html`

**位置：** 在"溯源回放地址"字段之后

**UI 设计：**

```html
<div class="form-group">
    <label class="control-label col-xs-12 col-sm-2">视频列表二维码:</label>
    <div class="col-xs-12 col-sm-8">
        <!-- 日期选择 -->
        <div class="input-group" style="margin-bottom: 10px;">
            <span class="input-group-addon">日期</span>
            <input type="date" id="qr-date" class="form-control" value="">
        </div>

        <!-- 分类选择 -->
        <div class="input-group" style="margin-bottom: 10px;">
            <span class="input-group-addon">分类</span>
            <select id="qr-type" class="form-control">
                <option value="0">商品溯源</option>
                <option value="1">精彩瞬间</option>
                <option value="2">多视角回放</option>
            </select>
        </div>

        <!-- 生成按钮 -->
        <button type="button" class="btn btn-primary" onclick="generateQRCode()">
            <i class="fa fa-qrcode"></i> 生成二维码
        </button>

        <!-- 二维码显示区域 -->
        <div id="qrcode-container" style="margin-top: 20px; display: none;">
            <div id="qrcode" style="text-align: center;"></div>
            <div style="text-align: center; margin-top: 10px;">
                <button type="button" class="btn btn-success" onclick="downloadQRCode()">
                    <i class="fa fa-download"></i> 下载二维码
                </button>
            </div>
        </div>
    </div>
</div>
```

---

### 位置2：视频管理页面（独立页面）

**新建页面：** `kcbg/application/admin/view/shop/video/qrcode.html`

**功能：**
- 批量生成多个日期的二维码
- 批量生成多个分类的二维码
- 批量下载二维码

---

## 🔧 技术实现方案

### 后端实现

#### 方案A：使用 PHP 生成二维码（推荐）

**库：** `phpqrcode` 或 `endroid/qr-code`

**安装：**
```bash
composer require endroid/qr-code
```

**控制器方法：**

**文件：** `kcbg/addons/shop/controller/admin/Goods.php`

```php
use Endroid\QrCode\QrCode;
use Endroid\QrCode\Writer\PngWriter;

public function generateQrCode()
{
    $goods_id = $this->request->param('goods_id');
    $date = $this->request->param('date');
    $type = $this->request->param('type', 0);

    // 构建小程序页面路径
    $path = "/pages/goods/detail?id={$goods_id}";
    if ($date) {
        $path .= "&date={$date}";
    }
    if ($type !== null) {
        $path .= "&type={$type}";
    }

    // 生成二维码
    $qrCode = QrCode::create($path)
        ->setSize(300)
        ->setMargin(10);

    $writer = new PngWriter();
    $result = $writer->write($qrCode);

    // 返回 base64 编码的图片
    $base64 = base64_encode($result->getString());

    $this->success('生成成功', [
        'qrcode' => 'data:image/png;base64,' . $base64,
        'url' => $path
    ]);
}
```

**路由配置：**

**文件：** `kcbg/addons/shop/config.php`

```php
'admin_route' => [
    'goods/generateQrCode' => 'shop/goods/generateQrCode',
],
```

---

#### 方案B：使用前端 JavaScript 生成（更简单）

**库：** `qrcode.js` 或 `qrcodejs2`

**引入库：**

```html
<script src="https://cdn.jsdelivr.net/npm/qrcodejs2@0.0.2/qrcode.min.js"></script>
```

**JavaScript 实现：**

```javascript
function generateQRCode() {
    // 获取参数
    var goodsId = document.getElementById('c-id').value;
    var date = document.getElementById('qr-date').value;
    var type = document.getElementById('qr-type').value;

    // 构建 URL
    var url = '/pages/goods/detail?id=' + goodsId;
    if (date) {
        url += '&date=' + date;
    }
    if (type !== null) {
        url += '&type=' + type;
    }

    // 清空之前的二维码
    document.getElementById('qrcode').innerHTML = '';

    // 生成二维码
    var qrcode = new QRCode(document.getElementById('qrcode'), {
        text: url,
        width: 300,
        height: 300,
        colorDark: '#000000',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.H
    });

    // 显示二维码容器
    document.getElementById('qrcode-container').style.display = 'block';

    Layer.msg('二维码生成成功', {icon: 1});
}

function downloadQRCode() {
    // 获取二维码图片
    var canvas = document.querySelector('#qrcode canvas');
    if (!canvas) {
        var img = document.querySelector('#qrcode img');
        if (img) {
            // 如果是 img 标签，创建一个 canvas
            canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            var ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
        }
    }

    if (canvas) {
        // 转换为 blob 并下载
        canvas.toBlob(function(blob) {
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'qrcode-' + Date.now() + '.png';
            a.click();
            URL.revokeObjectURL(url);
        });
    }
}
```

---

### 前端实现（小程序）

#### 修改商品详情页接收参数

**文件：** `cwlsuniapp/pages/goods/detail.vue`

**修改 onLoad 方法：**

```javascript
onLoad(e) {
    this.id = e.id || e.goods_id || '';

    // 接收日期参数
    if (e.date) {
        this.targetDate = e.date;  // 保存目标日期
    }

    // 接收分类参数
    if (e.type !== undefined) {
        this.curNow = parseInt(e.type);  // 设置视频分类
    }

    let invite_id = e.invite_id || '';
    // ... 其他代码

    this.getGoodsInfo();
    this.getDateList('');
}
```

**修改 getDateList 方法：**

```javascript
getDateList(date) {
    this.$api.getdateList({ date: date }).then(res => {
        this.datearr = res.data;

        // 如果有目标日期，自动选择
        if (this.targetDate) {
            let targetIndex = this.datearr.findIndex(item =>
                item.riqi === this.targetDate
            );
            if (targetIndex !== -1) {
                this.riindex = targetIndex;
            }
            this.targetDate = null;  // 清除标记
        }

        this.getVideoList();
    });
}
```

**添加 data 属性：**

```javascript
data() {
    return {
        // ... 其他属性
        targetDate: null,  // 目标日期
    };
}
```

---

## 🎨 UI 效果图

### 后台管理页面

```
┌─────────────────────────────────────────┐
│  商品编辑                                │
├─────────────────────────────────────────┤
│  溯源回放地址:                           │
│  [/pages/index/sycpvideo?id=5] [复制]   │
│                                         │
│  视频列表二维码:                         │
│  日期: [2024-10-15]                     │
│  分类: [商品溯源 ▼]                     │
│  [生成二维码]                            │
│                                         │
│  ┌─────────────────┐                   │
│  │                 │                   │
│  │   [二维码图片]   │                   │
│  │                 │                   │
│  └─────────────────┘                   │
│  [下载二维码]                            │
└─────────────────────────────────────────┘
```

---

## 🔄 完整流程

### 流程图

```
后台管理员
    ↓
编辑商品
    ↓
选择日期和分类
    ↓
点击"生成二维码"
    ↓
系统生成二维码
    ↓
下载二维码图片
    ↓
印刷到产品包装上
    ↓
用户扫描二维码
    ↓
打开小程序商品详情页
    ↓
自动定位到指定日期和分类
    ↓
显示对应的视频列表
```

---

## 📝 实施步骤

### 步骤1：前端修改（小程序）

**文件：** `cwlsuniapp/pages/goods/detail.vue`

**修改内容：**
1. 在 `data` 中添加 `targetDate` 属性
2. 修改 `onLoad` 方法接收 `date` 和 `type` 参数
3. 修改 `getDateList` 方法自动选择目标日期

---

### 步骤2：后端添加二维码生成功能

**方案A：使用 PHP 生成**
1. 安装 `endroid/qr-code` 库
2. 在 `Goods.php` 控制器添加 `generateQrCode` 方法
3. 配置路由

**方案B：使用前端 JavaScript 生成（推荐）**
1. 在商品编辑页面引入 `qrcode.js` 库
2. 添加二维码生成区块的 HTML
3. 添加 JavaScript 生成和下载方法

---

### 步骤3：后台管理页面修改

**文件：** `kcbg/application/admin/view/shop/goods/edit.html`

**修改内容：**
1. 在"溯源回放地址"之后添加二维码生成区块
2. 添加日期选择器
3. 添加分类选择器
4. 添加生成按钮和下载按钮
5. 添加二维码显示区域

---

## 🧪 测试验证

### 测试步骤

#### 1. 测试二维码生成

```
1. 登录后台管理
2. 编辑商品（ID=33）
3. 选择日期：2024-10-15
4. 选择分类：商品溯源
5. 点击"生成二维码"
6. 验证二维码是否显示
7. 点击"下载二维码"
8. 验证图片是否下载成功
```

#### 2. 测试扫码跳转

```
1. 使用微信扫描生成的二维码
2. 验证是否打开小程序
3. 验证是否跳转到商品详情页
4. 验证日期是否自动选择为 2024-10-15
5. 验证分类是否自动切换到"商品溯源"
6. 验证视频列表是否正确加载
```

#### 3. 测试不同参数组合

| 测试场景 | URL | 预期结果 |
|---------|-----|---------|
| 只有商品ID | ?id=33 | 显示商品详情，默认日期和分类 |
| 商品ID+日期 | ?id=33&date=2024-10-15 | 自动选择指定日期 |
| 商品ID+分类 | ?id=33&type=1 | 自动切换到"精彩瞬间" |
| 完整参数 | ?id=33&date=2024-10-15&type=2 | 自动选择日期和"多视角回放" |

---

## 💡 优化建议

### 1. 批量生成二维码

**功能：** 一次性生成多个日期的二维码

**实现：**
```javascript
function batchGenerateQRCodes() {
    var startDate = document.getElementById('start-date').value;
    var endDate = document.getElementById('end-date').value;
    var type = document.getElementById('qr-type').value;

    // 生成日期范围内的所有二维码
    // 打包成 ZIP 文件下载
}
```

---

### 2. 二维码美化

**功能：** 添加 Logo、颜色、样式

**实现：**
```javascript
var qrcode = new QRCode(document.getElementById('qrcode'), {
    text: url,
    width: 300,
    height: 300,
    colorDark: '#000000',
    colorLight: '#ffffff',
    correctLevel: QRCode.CorrectLevel.H,
    // 添加 Logo
    logo: '/path/to/logo.png',
    logoWidth: 60,
    logoHeight: 60
});
```

---

### 3. 短链接支持

**功能：** 将长 URL 转换为短链接

**优点：**
- 二维码更简单
- 扫描速度更快
- 容错率更高

**实现：**
```php
public function generateShortUrl($longUrl)
{
    // 使用短链接服务（如 bit.ly）
    // 或自建短链接系统
    return $shortUrl;
}
```

---

### 4. 二维码统计

**功能：** 统计二维码扫描次数

**实现：**
1. 生成二维码时创建唯一ID
2. URL 中包含统计ID
3. 小程序打开时上报统计数据
4. 后台显示扫描统计

---

## 🎯 推荐方案

### 推荐：方案B（前端 JavaScript 生成）

**理由：**
1. ✅ 实现简单，无需后端修改
2. ✅ 无需安装额外的 PHP 库
3. ✅ 生成速度快，无需网络请求
4. ✅ 支持实时预览
5. ✅ 支持本地下载

**实施步骤：**
1. 在商品编辑页面引入 `qrcode.js`
2. 添加二维码生成区块
3. 修改小程序接收参数逻辑
4. 测试验证

---

## 📋 需要确认的问题

1. **二维码生成位置**
   - [ ] 在商品编辑页面（推荐）
   - [ ] 创建独立的二维码管理页面

2. **技术方案**
   - [ ] 使用 PHP 后端生成
   - [ ] 使用 JavaScript 前端生成（推荐）

3. **URL 参数设计**
   - [ ] 使用商品详情页 + 参数（推荐）
   - [ ] 创建独立的视频列表页

4. **功能范围**
   - [ ] 基础功能：生成和下载单个二维码
   - [ ] 扩展功能：批量生成、美化、统计

5. **日期格式**
   - [ ] YYYY-MM-DD（如：2024-10-15）
   - [ ] 其他格式

---

**请确认以上方案，我再继续实施。**

---

**设计人员：** Claude Code
**设计日期：** 2026年2月6日
**文档版本：** v1.0
