# 商品详情页展示逻辑分析

## 📋 文档信息

- **页面路径：** `cwlsuniapp/pages/goods/detail.vue`
- **页面功能：** 商品详情展示、规格选择、购物车、溯源视频回放
- **分析日期：** 2026年2月5日

---

## 🎯 页面结构概览

### 页面布局顺序

```
1. 顶部导航栏
2. 商品图片轮播
3. 商品基本信息（标题、价格、分享、收藏）
4. 优惠券区块（条件显示）
5. 商品规格区块（条件显示）
6. 商品属性区块（条件显示）
7. 溯源回放入口（条件显示）← 新增功能
8. 生产日期选择 + 视频回放列表
9. 商品详情
10. 热门商品推荐
11. 底部操作栏（客服、购物车、加购、购买）
```

---

## 📊 数据结构

### data 属性

```javascript
{
    info: {},                    // 商品详情数据
    id: '',                      // 商品ID
    cart_nums: 0,                // 购物车数量
    show: false,                 // 规格选择弹窗
    guarantee_show: false,       // 服务保障弹窗
    sceneval: 2,                 // 场景值：1=加购，2=购买
    loading: true,               // 骨架屏加载状态
    swiperIndex: 0,              // 轮播图当前索引
    showReplay: false,           // 评论回复弹窗
    replyId: '',                 // 回复的评论ID
    showShare: false,            // 分享弹窗
    showPoster: false,           // 海报弹窗
    showCoupon: false,           // 优惠券弹窗
    recommends: [],              // 推荐商品列表
    list: ['商品溯源', '精彩瞬间', '多视角回放'],  // 视频分类
    riqishow: false,             // 日期选择弹窗
    datearr: [],                 // 日期数组
    dy: "2024-10",               // 当前年月
    riindex: 3,                  // 选中的日期索引
    curNow: 0,                   // 当前视频分类索引
    videoList: [],               // 视频列表
    videoshow: false,            // 视频播放弹窗
    videourl: ''                 // 视频URL
}
```

### info 对象结构（从API返回）

```javascript
{
    id: Number,                  // 商品ID
    title: String,               // 商品标题
    subtitle: String,            // 商品副标题
    price: String,               // 售价
    marketprice: String,         // 市场价
    image: String,               // 主图
    images: Array,               // 图片数组
    is_collect: Boolean,         // 是否已收藏
    coupon: Array,               // 优惠券列表
    sku_spec: Array,             // 规格列表
    guarantee: Array,            // 服务保障列表
    attributes: Array,           // 商品属性列表
    traceability_url: String,    // 溯源回放地址（新增）
    ri: Array,                   // 可选日期列表
    content: String,             // 商品详情HTML
    comment: Array,              // 评论列表
    favor_rate: Number,          // 好评度
    category_id: Number          // 分类ID
}
```

---

## 🔄 生命周期与数据加载

### onLoad(e)

**触发时机：** 页面加载时

**执行逻辑：**

```javascript
1. 获取商品ID
   - 从 e.id 或 e.goods_id 获取
   - 从 scene 参数解码获取（小程序码场景）

2. 获取邀请人ID
   - 从 e.invite_id 或 scene 中获取
   - 存储到 vuex

3. 调用数据加载方法
   - getGoodsInfo()      // 获取商品详情
   - getDateList('')     // 获取日期列表
```

### onShow()

**触发时机：** 页面显示时

**执行逻辑：**

```javascript
1. 如果已登录，获取购物车数量
   - getCartNums()

2. 设置当前年月
   - 获取当前年份和月份
   - 设置 dy 变量用于日期选择器显示
```

---

## 🎨 条件渲染逻辑

### 1. 优惠券区块

**显示条件：**
```vue
v-if="info.coupon && info.coupon.length"
```

**逻辑：**
- 商品有优惠券数据
- 优惠券数组不为空

**显示内容：**
- 优惠券列表（满减/折扣）
- 点击可查看详情

---

### 2. 商品规格区块

**显示条件：**
```vue
v-if="info.sku_spec && info.sku_spec.length"
```

**逻辑：**
- 商品有规格数据
- 规格数组不为空

**显示内容：**
- 已选规格的文本描述
- 点击打开规格选择弹窗

**计算属性 skuSpecAttr：**
```javascript
// 将规格数据格式化为文本
// 例如：颜色:红色,蓝色-尺寸:S,M,L
skuSpecAttr() {
    let arr = [];
    if (this.info.sku_spec) {
        for (let sku of this.info.sku_spec) {
            let valArr = sku.sku_value.map(item => item.title);
            arr.push(sku.title + ':' + valArr.join(','));
        }
    }
    return arr.join('-');
}
```

---

### 3. 服务保障区块（已注释）

**显示条件：**
```vue
v-if="info.guarantee && info.guarantee.length"
```

**状态：** 当前已被注释掉，不显示

---

### 4. 商品属性区块

**显示条件：**
```vue
v-if="info.attributes && info.attributes.length"
```

**逻辑：**
- 商品有属性数据
- 属性数组不为空

**显示内容：**
- 属性表格（名称-属性值）
- 使用 u-table 组件展示

**数据格式：**
```javascript
attributes: [
    {
        name: "品牌",
        attribute_value: [
            { name: "Nike" },
            { name: "Adidas" }
        ]
    }
]
```

---

### 5. 溯源回放入口（新增功能）

**显示条件：**
```vue
v-if="info.traceability_url"
```

**逻辑：**
- 商品配置了溯源回放地址
- traceability_url 字段不为空

**显示内容：**
- 标题："溯源回放"
- 图标：视频图标（蓝色）
- 文字："查看溯源回放"
- 右箭头

**点击事件：**
```javascript
goToTraceability() {
    if (this.info.traceability_url) {
        uni.navigateTo({
            url: this.info.traceability_url
        });
    }
}
```

**位置：** 商品属性区块之后，生产日期选择之前

---

### 6. 生产日期选择 + 视频回放区块

**显示条件：** 始终显示（无条件）

**功能模块：**

#### 6.1 日期选择器

```vue
<view @click="riqishow = true">
    {{dy}} ▼
</view>
```

**逻辑：**
- 显示当前选中的年月
- 点击打开日历选择器
- 选择后调用 changedate(e)

#### 6.2 日期列表

```vue
<view v-for="(item, index) in datearr" @click="xx(index)">
    {{item.txt}}<br>
    {{item.day}}
</view>
```

**逻辑：**
- 显示当前月份的可选日期
- 点击切换选中日期
- 选中后重新加载视频列表

#### 6.3 视频分类切换

```vue
<u-subsection
    :list="list"
    :current="curNow"
    @change="sectionChange">
</u-subsection>
```

**分类：**
- 商品溯源（curNow=0）
- 精彩瞬间（curNow=1）
- 多视角回放（curNow=2）

**逻辑：**
- 切换分类后重新加载视频列表

#### 6.4 视频列表

```vue
<view v-for="(item, index) in videoList">
    <!-- 视频信息 -->
    <view @click="openVideo(index)">点击回放</view>
</view>
```

**显示内容：**
- 标签（tag）
- 标题（title）
- 播放时长（shichang）
- 时间段（s_time - e_time）
- 亮点（liangdian）

**点击事件：**
```javascript
openVideo(i) {
    uni.navigateTo({
        url: "/pages/video/video?url=" + this.videoList[i].video_url
    });
}
```

---

### 7. 商品详情区块

**显示条件：** 始终显示

**内容：**
- 使用 u-parse 组件解析 HTML
- 显示商品详情富文本

---

### 8. 评论区块（已注释）

**显示条件：**
```vue
v-if="!noComment(info.comment)"
```

**状态：** 当前已被注释掉，不显示

**计算属性 noComment：**
```javascript
noComment() {
    return item => {
        if (!item) return true;
        if (!item.length) return true;
        return false;
    };
}
```

---

### 9. 热门商品推荐

**显示条件：** 始终显示

**数据来源：**
```javascript
getGoods(category_id) {
    this.$api.getGoodsIndex().then(({code, data:res, msg}) => {
        if (code) {
            this.recommends = res.hots;
        }
    });
}
```

**显示内容：**
- 商品图片
- 商品名称
- 价格
- 市场价（如果有）

**点击事件：**
```javascript
@click="goPage('/pages/goods/detail?id=' + item.id)"
```

---

### 10. 底部操作栏

**显示条件：** 始终显示

**功能按钮：**

| 按钮 | 功能 | 事件 |
|------|------|------|
| 客服 | 打开客服会话 | open-type="contact" |
| 购物车 | 跳转购物车页面 | goPage('/pages/cart/cart') |
| 加入购物车 | 打开规格选择（sceneval=1） | show=true |
| 立即购买 | 打开规格选择（sceneval=2） | show=true |

**购买按钮文案逻辑：**
```javascript
{{ parseFloat(info.price)==0 ? '免费获取' : '立即购买' }}
```

---

## 🔄 数据加载流程

### 1. 获取商品详情

**方法：** `getGoodsInfo()`

**流程：**

```javascript
1. 检查商品ID是否存在
   ↓
2. 调用 API: getGoodsInfo({ id: this.id })
   ↓
3. 成功返回
   ├─ 设置 this.info = res.data
   ├─ 配置小程序分享信息
   ├─ 配置微信分享信息（H5）
   ├─ 设置 loading = false
   └─ 获取推荐商品 getGoods(category_id)
   ↓
4. 失败返回
   ├─ 显示错误提示
   └─ 1.5秒后返回上一页
```

---

### 2. 获取日期列表

**方法：** `getDateList(date)`

**流程：**

```javascript
1. 调用 API: getdateList({ date: date })
   ↓
2. 设置 this.datearr = res.data
   ↓
3. 自动调用 getVideoList() 加载视频
```

**数据格式：**
```javascript
datearr: [
    { txt: "周一", day: "01", riqi: "2024-10-01" },
    { txt: "周二", day: "02", riqi: "2024-10-02" },
    ...
]
```

---

### 3. 获取视频列表

**方法：** `getVideoList()`

**流程：**

```javascript
1. 调用 API: getVideoList({
    date: this.datearr[this.riindex].riqi,  // 选中的日期
    type: this.curNow,                       // 视频分类
    goods_id: this.id                        // 商品ID
})
   ↓
2. 设置 this.videoList = res.data
```

**触发时机：**
- 页面加载时
- 切换日期时
- 切换视频分类时
- 选择新的年月时

---

### 4. 获取购物车数量

**方法：** `getCartNums()`

**流程：**

```javascript
1. 调用 API: cart_nums()
   ↓
2. 设置 this.cart_nums = res.data || 0
```

**触发时机：**
- 页面显示时（onShow）
- 加购成功后（@success="getCartNums"）

---

## 🎯 用户交互逻辑

### 1. 图片预览

**触发：** 点击商品图片或评论图片

**方法：** `preview(images, index)`

**功能：**
- 全屏预览图片
- 支持左右滑动
- 长按可保存/分享

---

### 2. 收藏/取消收藏

**触发：** 点击收藏按钮

**方法：** `optionCollect()`

**流程：**

```javascript
1. 调用 API: optionCollect({ goods_id: this.id })
   ↓
2. 显示提示信息
   ↓
3. 成功后切换收藏状态
   this.$set(this.info, 'is_collect', !this.info.is_collect)
```

**UI 变化：**
- 未收藏：空心星星 + "收藏"
- 已收藏：实心星星 + "已收藏"（主题色）

---

### 3. 分享功能

**触发：** 点击分享按钮

**方法：** 设置 `showShare = true`

**功能：**
- 打开分享弹窗
- 支持生成海报
- 支持微信分享（H5）
- 支持小程序分享

---

### 4. 规格选择

**触发：**
- 点击"商品规格"区块
- 点击"加入购物车"按钮
- 点击"立即购买"按钮

**方法：** 设置 `show = true` 和 `sceneval`

**sceneval 值：**
- 0：查看规格
- 1：加入购物车
- 2：立即购买

**组件：** `<fa-skus>`

---

### 5. 日期选择

**触发：**
- 点击年月选择器
- 点击日期列表中的某一天

**方法：**
- `riqishow = true`：打开日历
- `xx(index)`：选择日期
- `changedate(e)`：切换年月

**流程：**

```javascript
// 切换年月
changedate(e) {
    this.getDateList(e.result);  // 重新获取日期列表
    this.dy = e.year + "-" + e.month;  // 更新显示
    this.getVideoList();  // 重新加载视频
}

// 选择日期
xx(index) {
    this.riindex = index;  // 更新选中索引
    this.getVideoList();  // 重新加载视频
}
```

---

### 6. 视频分类切换

**触发：** 点击分类按钮

**方法：** `sectionChange(index)`

**流程：**

```javascript
sectionChange(index) {
    this.curNow = index;  // 更新当前分类
    this.getVideoList();  // 重新加载视频
}
```

---

### 7. 视频回放

**触发：** 点击"点击回放"按钮

**方法：** `openVideo(i)`

**流程：**

```javascript
openVideo(i) {
    uni.navigateTo({
        url: "/pages/video/video?url=" + this.videoList[i].video_url
    });
}
```

---

### 8. 溯源回放（新增）

**触发：** 点击"查看溯源回放"

**方法：** `goToTraceability()`

**流程：**

```javascript
goToTraceability() {
    if (this.info.traceability_url) {
        uni.navigateTo({
            url: this.info.traceability_url
        });
    }
}
```

**跳转目标：**
- `/pages/index/sycpvideo?id=X`（配料全程回放）
- `/pages/ingredientreplay/videos?id=X`（溯源回放）

---

## 📱 弹窗管理

### 弹窗列表

| 弹窗 | 变量 | 触发条件 | 内容 |
|------|------|---------|------|
| 规格选择 | show | 点击规格/加购/购买 | 商品规格选择 |
| 服务保障 | guarantee_show | 点击服务保障 | 服务保障详情 |
| 分享 | showShare | 点击分享按钮 | 分享选项 |
| 海报 | showPoster | 点击生成海报 | 商品海报 |
| 优惠券 | showCoupon | 点击优惠券 | 优惠券列表 |
| 评论回复 | showReplay | 点击回复按钮 | 回复输入框 |
| 日历 | riqishow | 点击日期选择 | 日历选择器 |
| 视频播放 | videoshow | 点击视频（已注释） | 视频播放器 |

---

## 🎨 样式与主题

### 主题色使用

```javascript
// 从 vuex 获取主题色
theme.bgColor  // 背景色
theme.color    // 文字色
```

**应用位置：**
- 分享图标
- 收藏图标（已收藏状态）
- 评论回复按钮
- 立即购买按钮

---

### 骨架屏

**控制变量：** `loading`

**显示时机：**
- 页面加载时：`loading = true`
- 数据加载完成：`loading = false`

**组件：**
```vue
<u-skeleton :loading="loading" :animation="true" bgColor="#FFF"></u-skeleton>
```

---

## 🔍 关键逻辑总结

### 1. 数据加载顺序

```
onLoad
  ├─ getGoodsInfo()
  │    ├─ 获取商品详情
  │    └─ getGoods() → 获取推荐商品
  └─ getDateList('') → 获取日期列表
       └─ getVideoList() → 获取视频列表

onShow
  └─ getCartNums() → 获取购物车数量
```

---

### 2. 视频列表更新触发条件

```
1. 页面加载时
2. 切换年月时（changedate）
3. 切换日期时（xx）
4. 切换视频分类时（sectionChange）
```

---

### 3. 条件显示区块

```
优惠券：info.coupon && info.coupon.length
规格：info.sku_spec && info.sku_spec.length
属性：info.attributes && info.attributes.length
溯源回放：info.traceability_url  ← 新增
```

---

### 4. 页面跳转

| 触发 | 目标页面 | 参数 |
|------|---------|------|
| 点击推荐商品 | /pages/goods/detail | id |
| 点击购物车 | /pages/cart/cart | - |
| 点击更多评论 | /pages/remark/lists | goods_id |
| 点击视频回放 | /pages/video/video | url |
| 点击溯源回放 | traceability_url | - |

---

## 🆕 新增功能：溯源回放入口

### 显示逻辑

```vue
<view class="bg-white u-m-t-30" v-if="info.traceability_url">
    <view class="u-p-l-30 u-p-r-30 u-p-t-30 text-weight">溯源回放</view>
    <view class="u-p-30 u-flex u-row-between" @click="goToTraceability">
        <view class="u-flex">
            <u-icon name="video" color="#367bf7" size="32"></u-icon>
            <text class="u-m-l-15 u-font-28">查看溯源回放</text>
        </view>
        <u-icon name="arrow-right" color="#909399"></u-icon>
    </view>
</view>
```

### 跳转方法

```javascript
goToTraceability() {
    if (this.info.traceability_url) {
        uni.navigateTo({
            url: this.info.traceability_url
        });
    }
}
```

### 数据来源

- 从 API 返回的 `info.traceability_url` 字段
- 后台管理配置的小程序页面路径
- 格式：`/pages/index/sycpvideo?id=X` 或 `/pages/ingredientreplay/videos?id=X`

### 显示位置

```
商品属性区块
    ↓
溯源回放入口（新增）← 这里
    ↓
生产日期选择 + 视频回放
```

---

## 📊 性能优化建议

### 1. 数据加载优化

- 商品详情和推荐商品可以并行加载
- 视频列表按需加载（切换时才加载）
- 图片使用懒加载

### 2. 条件渲染优化

- 使用 v-if 而不是 v-show（不常切换的内容）
- 评论区块已注释，减少渲染负担

### 3. 计算属性缓存

- skuSpecAttr 使用计算属性，自动缓存
- noComment 使用计算属性，避免重复计算

---

## 🐛 潜在问题

### 1. 视频列表加载

**问题：** 依赖 `datearr[riindex]` 可能导致数组越界

**建议：** 添加边界检查

```javascript
getVideoList() {
    if (!this.datearr[this.riindex]) return;

    this.$api.getVideoList({
        date: this.datearr[this.riindex].riqi,
        type: this.curNow,
        goods_id: this.id
    }).then(res => {
        this.videoList = res.data;
    });
}
```

### 2. 商品ID缺失

**问题：** 如果没有传入商品ID，页面会空白

**建议：** 添加错误处理

```javascript
getGoodsInfo() {
    if (!this.id) {
        this.$u.toast('商品不存在');
        setTimeout(() => {
            uni.navigateBack();
        }, 1500);
        return;
    }
    // ... 继续执行
}
```

---

## ✅ 总结

### 页面特点

1. **功能丰富：** 商品展示、规格选择、视频回放、溯源追踪
2. **条件渲染：** 根据数据动态显示区块
3. **交互复杂：** 多个弹窗、日期选择、视频切换
4. **数据联动：** 日期、分类、视频列表三者联动

### 核心流程

```
用户进入页面
    ↓
加载商品详情
    ↓
显示基本信息
    ↓
根据配置显示可选区块
    ├─ 优惠券
    ├─ 规格
    ├─ 属性
    └─ 溯源回放（新增）
    ↓
加载视频列表
    ↓
用户交互（选择日期、分类、观看视频）
    ↓
加购或购买
```

### 新增功能集成

溯源回放入口已完美集成到页面中：
- 位置合理（属性之后，视频之前）
- 条件显示（有配置才显示）
- 跳转灵活（支持多种溯源页面）
- 样式统一（与其他区块一致）

---

**分析完成日期：** 2026年2月5日
**分析人员：** Claude Code
