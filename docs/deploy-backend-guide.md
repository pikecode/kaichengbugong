# 后端部署脚本使用说明

## 📦 脚本文件

`docs/deploy-backend.sh` - 自动化部署后台管理和API文件到生产服务器

## ✨ 功能特性

- ✅ 自动备份现有文件
- ✅ 上传后台管理文件
- ✅ 上传API文件
- ✅ 自动清理缓存
- ✅ 可选的数据库迁移
- ✅ 部署验证
- ✅ 一键回滚功能
- ✅ 彩色输出，清晰易读

## 🔧 前置要求

### 1. 安装依赖

```bash
# macOS
brew install hudochenkov/sshpass/sshpass

# Ubuntu/Debian
sudo apt-get install sshpass

# CentOS/RHEL
sudo yum install sshpass
```

### 2. 配置信息

脚本已预配置以下信息（如需修改请编辑脚本）：

- **服务器地址：** 8.154.32.2
- **服务器用户：** root
- **服务器密码：** Pp@123456
- **项目路径：** /www/wwwroot/cwls.turuifanxin.cn
- **数据库用户：** cwls
- **数据库密码：** ewXHjm77twRm3xL2

## 🚀 使用方法

### 基本部署

```bash
cd /Users/peakom/worko/kaichengbugong
./docs/deploy-backend.sh
```

### 执行流程

脚本会自动执行以下步骤：

1. **前置检查**
   - 检查必需命令（sshpass, ssh, scp）
   - 检查本地文件是否存在

2. **创建备份目录**
   - 在服务器上创建带时间戳的备份目录
   - 格式：`/backup/YYYYMMDD_HHMMSS`

3. **备份现有文件**
   - 备份后台管理文件
   - 备份API文件

4. **部署后台文件**
   - 上传 `kcbg/application/admin/view/shop/goods/edit.html`

5. **部署API文件**
   - 上传 `kcbg/addons/shop/controller/api/Goods.php`

6. **清理缓存**
   - 清理 `runtime/cache/*`
   - 清理 `runtime/temp/*`

7. **数据库迁移（可选）**
   - 提示是否执行数据库迁移
   - 添加 `date_urls` 字段到 `fa_shop_goods` 表
   - 自动检查字段是否已存在，避免重复执行

8. **验证部署**
   - 检查文件是否成功上传

### 回滚操作

如果部署出现问题，可以回滚到备份：

```bash
./docs/deploy-backend.sh rollback /backup/20260206_123456
```

回滚操作会：
- 恢复后台管理文件
- 恢复API文件
- 清理缓存

### 查看帮助

```bash
./docs/deploy-backend.sh help
```

## 📋 输出示例

```
╔════════════════════════════════════════════╗
║     后端部署脚本 - 日期地址配置功能      ║
╚════════════════════════════════════════════╝

============================================
步骤1：前置检查
============================================
[SUCCESS] 前置检查通过

============================================
步骤2：创建备份目录
============================================
[SUCCESS] 备份目录创建成功: /backup/20260206_150030

============================================
步骤3：备份现有文件
============================================
[INFO] 备份后台管理文件...
[SUCCESS] 后台文件备份成功
[INFO] 备份API文件...
[SUCCESS] API文件备份成功

============================================
步骤4：部署后台管理文件
============================================
[INFO] 上传后台文件...
[SUCCESS] 后台文件部署成功

============================================
步骤5：部署API文件
============================================
[INFO] 上传API文件...
[SUCCESS] API文件部署成功

============================================
步骤6：清理缓存
============================================
[INFO] 清理runtime缓存...
[SUCCESS] 缓存清理成功

============================================
步骤7：数据库迁移（可选）
============================================
是否执行数据库迁移（添加 date_urls 字段）？[y/N]: y
[INFO] 执行数据库迁移...
[SUCCESS] 数据库迁移成功

============================================
步骤8：验证部署
============================================
[INFO] 验证文件...
[SUCCESS] 后台文件存在
[SUCCESS] API文件存在

============================================
✅ 部署完成！
============================================

备份位置: /backup/20260206_150030
如需回滚，请执行: ./docs/deploy-backend.sh rollback /backup/20260206_150030

下一步：
1. 登录后台测试配置功能
2. 编译并上传小程序
3. 测试完整流程
```

## ⚠️ 注意事项

### 安全性

- 脚本包含服务器密码，请妥善保管
- 建议配置SSH密钥认证替代密码
- 不要将脚本提交到公开的Git仓库

### 数据库迁移

- 首次部署时选择执行数据库迁移
- 脚本会自动检查字段是否已存在
- 如果字段已存在，会跳过迁移避免错误

### 备份管理

- 每次部署都会创建新的备份目录
- 建议定期清理旧备份，节省空间
- 备份目录命名格式：`/backup/YYYYMMDD_HHMMSS`

### 回滚限制

- 回滚只恢复文件，不回滚数据库
- 如需回滚数据库，请手动执行：
  ```sql
  ALTER TABLE fa_shop_goods DROP COLUMN `date_urls`;
  ```

## 🔍 故障排查

### 问题1：sshpass命令不存在

**错误信息：**
```
[ERROR] sshpass 未安装，请先安装
```

**解决方案：**
```bash
# macOS
brew install hudochenkov/sshpass/sshpass

# Ubuntu/Debian
sudo apt-get install sshpass
```

### 问题2：SSH连接失败

**错误信息：**
```
Permission denied, please try again.
```

**可能原因：**
- 服务器密码错误
- SSH端口不是默认的22
- 服务器禁止密码登录

**解决方案：**
1. 检查服务器密码是否正确
2. 如果SSH端口不是22，修改脚本添加 `-p 端口号`
3. 配置SSH密钥认证

### 问题3：文件上传失败

**错误信息：**
```
[ERROR] 后台文件部署失败
```

**可能原因：**
- 本地文件路径不正确
- 服务器磁盘空间不足
- 服务器目录权限问题

**解决方案：**
1. 检查本地文件是否存在
2. 检查服务器磁盘空间：`df -h`
3. 检查服务器目录权限：`ls -la`

### 问题4：数据库迁移失败

**错误信息：**
```
[ERROR] 数据库迁移失败
ERROR 1045 (28000): Access denied for user
```

**可能原因：**
- 数据库密码错误
- 数据库用户没有ALTER权限

**解决方案：**
1. 检查数据库密码是否正确
2. 授予用户ALTER权限：
   ```sql
   GRANT ALTER ON cwls.* TO 'cwls'@'localhost';
   FLUSH PRIVILEGES;
   ```

## 📚 相关文档

- [日期地址配置功能部署说明.md](../日期地址配置功能部署说明.md) - 完整功能说明
- [date_urls_fix.md](../date_urls_fix.md) - 问题修复记录
- [database_update_date_urls.sql](../database_update_date_urls.sql) - 数据库迁移脚本

## 🤝 支持

如遇到问题或需要帮助，请联系技术支持。

---

**版本：** 1.0.0
**最后更新：** 2026-02-06
