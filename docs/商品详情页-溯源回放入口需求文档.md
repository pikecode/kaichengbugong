# 商品详情页 - 溯源回放入口需求文档

## 📋 文档信息

- **文档名称：** 商品详情页溯源回放入口需求文档
- **创建日期：** 2026年2月5日
- **文档版本：** v1.0
- **关联文档：** `商品详情页-溯源视频功能分析.md`

---

## 🎯 需求背景

### 业务场景

后台维护"溯源商品"或"配料回放"时，每个商品都可以生成一个地址。然后可以将这个地址配置到"商城商品"页面，小程序查看商品详情时，如果配置了溯源地址，就可以根据配置跳转到对应的溯源回放列表或配料全程回放列表。

### 现有页面

| 页面 | 路径 | 说明 |
|------|------|------|
| 商品详情页 | `cwlsuniapp/pages/goods/detail.vue` | 显示商品详细信息 |
| 溯源商品回放 | `cwlsuniapp/pages/index/sycpvideo.vue` | 配料全程回放页面 |
| 配料回放视频 | `cwlsuniapp/pages/ingredientreplay/videos.vue` | 溯源回放页面 |

### 跳转目标

| 溯源类型 | 目标页面 | 参数 | 说明 |
|----------|---------|------|------|
| 溯源商品 | `sycpvideo.vue` | `traceabilitygoods_id` | 配料全程回放 |
| 配料回放 | `videos.vue` | `ingredientreplayitem_id` | 溯源回放 |

---

## 📊 需求分析

### 功能需求

1. **后台配置功能**
   - 在商城商品管理中添加溯源配置
   - 选择溯源类型（溯源商品/配料回放）
   - 选择关联的溯源商品或配料回放项目
   - 保存配置

2. **前端显示功能**
   - 商品详情页根据配置显示溯源入口
   - 入口显示对应的文案（配料全程回放/溯源回放）
   - 点击入口跳转到对应页面

3. **数据传递**
   - 传递正确的参数到目标页面
   - 确保目标页面能正确接收并显示数据

---

## 💡 设计方案

### 方案一：商品表添加关联字段（推荐）

#### 数据库修改

**表：** `fa_shop_goods`

**新增字段：**

```sql
ALTER TABLE `fa_shop_goods`
ADD COLUMN `traceability_type` TINYINT(1) DEFAULT 0
COMMENT '溯源类型：0=无，1=溯源商品，2=配料回放',

ADD COLUMN `traceability_id` INT(11) DEFAULT NULL
COMMENT '关联ID：溯源商品ID或配料回放ID';
```

#### 字段说明

| 字段名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| traceability_type | TINYINT(1) | 0 | 0=无，1=溯源商品，2=配料回放 |
| traceability_id | INT(11) | NULL | 关联的溯源商品ID或配料回放ID |

#### 优点

- 实现简单，直接在商品表添加字段
- 查询效率高，无需JOIN
- 易于维护

#### 缺点

- 一个商品只能关联一种溯源类型
- 如果需要同时关联多个入口，需要调整设计

---

### 方案二：创建关联表（支持多对多）

#### 数据库修改

**新建表：** `fa_shop_goods_traceability`

```sql
CREATE TABLE `fa_shop_goods_traceability` (
    `id` INT(11) NOT NULL AUTO_INCREMENT,
    `shop_goods_id` INT(11) NOT NULL COMMENT '商品ID',
    `type` TINYINT(1) NOT NULL COMMENT '类型：1=溯源商品，2=配料回放',
    `traceability_id` INT(11) NOT NULL COMMENT '溯源ID',
    `title` VARCHAR(100) DEFAULT NULL COMMENT '入口标题',
    `sort` INT(11) DEFAULT 0 COMMENT '排序',
    `status` TINYINT(1) DEFAULT 1 COMMENT '状态：0=禁用，1=启用',
    `createtime` INT(11) DEFAULT NULL,
    PRIMARY KEY (`id`),
    KEY `shop_goods_id` (`shop_goods_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='商品溯源关联表';
```

#### 优点

- 支持一个商品关联多个溯源入口
- 可以自定义入口标题
- 支持排序和启用/禁用
- 灵活性更高

#### 缺点

- 需要额外的表
- 查询时需要JOIN
- 实现相对复杂

---

## 🎨 前端设计方案

### 入口位置

**推荐位置：** 商品属性区块之后，视频回放区块之前

```
┌─────────────────────────────────┐
│  商品属性                       │
└─────────────────────────────────┘
         ↓
┌─────────────────────────────────┐
│  🎬 溯源回放入口                 │  ← 新增区块
│  ▶ 配料全程回放/溯源回放         │
└─────────────────────────────────┘
         ↓
┌─────────────────────────────────┐
│  选择商品生产日期...             │
│  商品溯源 | 精彩瞬间 | 多视角    │
└─────────────────────────────────┘
```

### UI效果

```vue
<!-- 溯源回放入口 -->
<view class="bg-white u-m-t-30" v-if="info.traceability_type > 0">
    <view class="u-p-l-30 u-p-r-30 u-p-t-30 text-weight">溯源回放</view>
    <view class="u-p-30 u-flex u-row-between" @click="goToTraceability">
        <view class="u-flex">
            <u-icon name="video" color="#367bf7" size="32"></u-icon>
            <text class="u-m-l-15 u-font-28">
                {{ info.traceability_type === 1 ? '配料全程回放' : '溯源回放' }}
            </text>
        </view>
        <u-icon name="arrow-right" color="#909399"></u-icon>
    </view>
</view>
```

---

## 🔄 数据流设计

### 1. 后台配置流程

```
后台管理员
    ↓
编辑商品
    ↓
选择溯源类型（溯源商品/配料回放）
    ↓
选择关联的溯源商品或配料回放项目
    ↓
保存配置
    ↓
数据库存储：
- traceability_type = 1 或 2
- traceability_id = 关联ID
```

### 2. 前端展示流程

```
用户打开商品详情
    ↓
调用 API：getGoodsInfo({ id })
    ↓
返回数据包含：
{
    id: 1,
    title: "商品名称",
    traceability_type: 1,  // 1=溯源商品
    traceability_id: 5,    // 溯源商品ID
    ...
}
    ↓
前端判断 traceability_type
    ↓
显示对应入口
    ↓
用户点击
    ↓
跳转到对应页面
```

### 3. 跳转逻辑

```javascript
goToTraceability() {
    if (this.info.traceability_type === 1) {
        // 跳转到溯源商品（配料全程回放）
        uni.navigateTo({
            url: `/pages/index/sycpvideo?id=${this.info.traceability_id}`
        });
    } else if (this.info.traceability_type === 2) {
        // 跳转到配料回放（溯源回放）
        uni.navigateTo({
            url: `/pages/ingredientreplay/videos?id=${this.info.traceability_id}`
        });
    }
}
```

---

## 🛠️ 实施步骤

### 第一步：数据库修改

**选择方案一（推荐）：**

```sql
-- 添加字段
ALTER TABLE `fa_shop_goods`
ADD COLUMN `traceability_type` TINYINT(1) DEFAULT 0
COMMENT '溯源类型：0=无，1=溯源商品，2=配料回放' AFTER `status`,

ADD COLUMN `traceability_id` INT(11) DEFAULT NULL
COMMENT '关联ID' AFTER `traceability_type`;

-- 验证
DESCRIBE fa_shop_goods;
```

---

### 第二步：后端API修改

**文件：** `kcbg/addons/shop/controller/api/Goods.php`

**修改 `detail` 方法，返回溯源配置：**

```php
public function detail()
{
    $id = $this->request->param('id');

    // ... 现有代码获取商品信息 ...

    // 添加溯源配置到返回数据
    $goods['traceability_type'] = $goods['traceability_type'] ?? 0;
    $goods['traceability_id'] = $goods['traceability_id'] ?? null;

    // ... 返回数据 ...
}
```

---

### 第三步：前端页面修改

**文件：** `cwlsuniapp/pages/goods/detail.vue`

**1. 在商品属性区块之后添加入口：**

```vue
<!-- 溯源回放入口 -->
<view class="bg-white u-m-t-30" v-if="info.traceability_type > 0">
    <view class="u-p-l-30 u-p-r-30 u-p-t-30 text-weight">溯源回放</view>
    <view class="u-p-30 u-flex u-row-between" @click="goToTraceability">
        <view class="u-flex">
            <u-icon name="video" color="#367bf7" size="32"></u-icon>
            <text class="u-m-l-15 u-font-28">
                {{ info.traceability_type === 1 ? '配料全程回放' : '溯源回放' }}
            </text>
        </view>
        <u-icon name="arrow-right" color="#909399"></u-icon>
    </view>
</view>
```

**2. 添加跳转方法：**

```javascript
methods: {
    // ... 现有方法 ...

    goToTraceability() {
        if (this.info.traceability_type === 1) {
            // 跳转到溯源商品（配料全程回放）
            uni.navigateTo({
                url: `/pages/index/sycpvideo?id=${this.info.traceability_id}`
            });
        } else if (this.info.traceability_type === 2) {
            // 跳转到配料回放（溯源回放）
            uni.navigateTo({
                url: `/pages/ingredientreplay/videos?id=${this.info.traceability_id}`
            });
        }
    }
}
```

---

### 第四步：后台管理界面（可选）

**文件：** `kcbg/application/admin/view/shop/goods/edit.html`

添加溯源配置表单：

```html
<div class="form-group">
    <label class="control-label col-xs-12 col-sm-2">溯源配置:</label>
    <div class="col-xs-12 col-sm-8">
        <select name="row[traceability_type]" class="form-control selectpicker">
            <option value="0">无溯源</option>
            <option value="1">溯源商品（配料全程回放）</option>
            <option value="2">配料回放（溯源回放）</option>
        </select>
    </div>
</div>

<div class="form-group">
    <label class="control-label col-xs-12 col-sm-2">关联ID:</label>
    <div class="col-xs-12 col-sm-8">
        <input type="number" name="row[traceability_id]" class="form-control" />
    </div>
</div>
```

---

## ✅ 测试验证

### 1. 数据库测试

```sql
-- 测试数据：配置商品ID=1关联到溯源商品ID=5
UPDATE fa_shop_goods
SET traceability_type = 1, traceability_id = 5
WHERE id = 1;

-- 验证
SELECT id, title, traceability_type, traceability_id
FROM fa_shop_goods
WHERE id = 1;
```

### 2. API测试

```bash
# 测试商品详情接口
curl "http://localhost:8080/index.php/addons/shop/api.goods/detail?id=1"
```

**预期返回：**

```json
{
    "code": 1,
    "data": {
        "id": 1,
        "title": "商品名称",
        "traceability_type": 1,
        "traceability_id": 5,
        ...
    }
}
```

### 3. 前端测试

1. 打开商品详情页（商品ID=1）
2. 应该看到"溯源回放"区块
3. 显示"配料全程回放"入口
4. 点击后跳转到 `/pages/index/sycpvideo?id=5`

---

## 🎨 UI效果图

```
┌─────────────────────────────────────┐
│  商品图片轮播                        │
├─────────────────────────────────────┤
│  商品标题                            │
│  ￥99.00                            │
│  分享| 收藏                         │
├─────────────────────────────────────┤
│  商品规格                            │
├─────────────────────────────────────┤
│  商品属性                            │
├─────────────────────────────────────┤
│  🎬 溯源回放          │  ← 新增
│  ▶ 配料全程回放              →│  ← 新增
├─────────────────────────────────────┤
│  选择商品生产日期...│
│  商品溯源 | 精彩瞬间 | 多视角        │
└─────────────────────────────────────┘
```

---

## 📋 需求确认清单

| 项目 | 状态 | 说明 |
|------|------|------|
| 需求背景 | ✅ | 后台配置溯源地址，前端显示入口 |
| 数据库方案 | ⬜ | 选择方案一或方案二 |
| 入口位置 | ✅ | 商品属性之后，视频区块之前 |
| 入口文案 | ⬜ | 配料全程回放/溯源回放 |
| 参数传递 | ⬜ | 确认参数名称和值 |
| 后台配置 | ⬜ | 手动输入还是下拉选择 |

---

## ❓ 待确认问题

1. **数据库方案选择：**
   - [ ] 方案一：商品表添加字段（简单，一对一）
   - [ ] 方案二：创建关联表（复杂，一对多）

2. **入口显示文案：**
   - [ ] 溯源商品（type=1）显示："配料全程回放"
   - [ ] 配料回放（type=2）显示："溯源回放"
   - 以上是否正确？

3. **后台配置方式：**
   - [ ] 手动输入关联ID
   - [ ] 下拉选择关联的溯源商品或配料回放项目

4. **是否需要显示图标或封面：**
   - [ ] 当前方案只显示文字入口
   - [ ] 是否需要添加图片或图标

5. **参数名称确认：**
   - [ ] `sycpvideo.vue` 接收的参数是 `id` 还是 `goods_id`？
   - [ ] `videos.vue` 接收的参数是 `id` 还是 `ingredientreplayitem_id`？

---

**文档维护者：** Claude Code
**最后更新：** 2026年2月5日
