# 溯源回放地址生成功能 - 实施文档

## 📋 文档信息

- **功能名称：** 后台管理 - 溯源回放地址生成
- **实施日期：** 2026年2月5日
- **文档版本：** v1.0

---

## ✅ 实施完成清单

| 页面 | 文件路径 | 状态 | 说明 |
|------|---------|------|------|
| 溯源商品编辑 | `traceabilitygoods/edit.html` | ✅ | 生成配料全程回放地址 |
| 配料回放编辑 | `ingredientreplay/edit.html` | ✅ | 生成溯源回放地址（已废弃） |
| 配料回放项目编辑 | `ingredientreplayitem/edit.html` | ✅ | 生成溯源回放地址（推荐） |

---

## 🎯 功能说明

### 功能概述

在后台管理的编辑页面中，自动生成小程序页面地址，管理员可以一键复制该地址，然后粘贴到商品管理的"溯源回放地址"字段中。

### 生成的地址格式

| 管理页面 | 生成的地址格式 | 跳转目标 |
|---------|---------------|---------|
| 溯源商品 | `/pages/index/sycpvideo?id={ID}` | 配料全程回放页面 |
| 配料回放项目 | `/pages/ingredientreplay/videos?id={ID}` | 溯源回放页面 |

---

## 📝 修改详情

### 1. 溯源商品编辑页面

**文件：** `kcbg/application/admin/view/traceabilitygoods/edit.html`

**添加内容：**

```html
<div class="form-group">
    <label class="control-label col-xs-12 col-sm-2">小程序地址:</label>
    <div class="col-xs-12 col-sm-8">
        <div class="input-group">
            <input id="c-miniapp-url" class="form-control" type="text" readonly
                   value="/pages/index/sycpvideo?id={$row.id}">
            <div class="input-group-addon no-border no-padding">
                <button type="button" class="btn btn-success" onclick="copyToClipboard()">
                    <i class="fa fa-copy"></i> 复制地址
                </button>
            </div>
        </div>
        <span class="help-block">
            将此地址复制后，粘贴到商品管理的"溯源回放地址"字段中
        </span>
    </div>
</div>

<script>
function copyToClipboard() {
    var input = document.getElementById('c-miniapp-url');
    input.select();
    input.setSelectionRange(0, 99999);

    try {
        document.execCommand('copy');
        Layer.msg('地址已复制到剪贴板', {icon: 1});
    } catch (err) {
        Layer.msg('复制失败，请手动复制', {icon: 2});
    }
}
</script>
```

**位置：** Weigh 字段之后，提交按钮之前

---

### 2. 配料回放项目编辑页面

**文件：** `kcbg/application/admin/view/ingredientreplayitem/edit.html`

**添加内容：** 与溯源商品相同，但地址格式为：
```
/pages/ingredientreplay/videos?id={$row.id}
```

**位置：** Weigh 字段之后，提交按钮之前

---

### 3. 配料回放编辑页面（已添加但不推荐使用）

**文件：** `kcbg/application/admin/view/ingredientreplay/edit.html`

**说明：** 此页面也添加了地址生成功能，但实际小程序需要的是 `ingredientreplayitem` 的 ID，不是 `ingredientreplay` 的 ID。

---

## 🎨 UI 效果

### 后台编辑页面

```
┌─────────────────────────────────────────┐
│  溯源商品编辑                            │
├─────────────────────────────────────────┤
│  标题: [________________]                │
│  图片: [________________] [上传] [选择]  │
│  排序: [1]                               │
│                                         │
│  小程序地址:                             │
│  [/pages/index/sycpvideo?id=5] [复制地址]│
│  将此地址复制后，粘贴到商品管理的        │
│  "溯源回放地址"字段中                    │
│                                         │
│  [确定] [重置]                           │
└─────────────────────────────────────────┘
```

---

## 🔄 使用流程

### 完整流程图

```
后台管理员
    ↓
编辑溯源商品或配料回放项目
    ↓
查看"小程序地址"字段
    ↓
点击"复制地址"按钮
    ↓
系统提示"地址已复制到剪贴板"
    ↓
进入商品管理 → 编辑商品
    ↓
在"溯源回放地址"字段粘贴地址
    ↓
保存商品
    ↓
小程序商品详情页显示溯源回放入口
    ↓
用户点击跳转到溯源页面
```

---

## 📖 使用说明

### 场景1：配置溯源商品（配料全程回放）

#### 步骤1：编辑溯源商品

1. 登录后台管理系统
2. 进入"溯源商品管理"
3. 点击"编辑"某个溯源商品
4. 在页面中找到"小程序地址"字段
5. 点击"复制地址"按钮

**生成的地址示例：**
```
/pages/index/sycpvideo?id=5
```

#### 步骤2：配置到商品

1. 进入"商品管理" → "商品列表"
2. 编辑需要关联的商品
3. 在"溯源回放地址"字段中粘贴地址
4. 保存商品

#### 步骤3：验证

1. 打开小程序商品详情页
2. 应该看到"溯源回放"入口
3. 点击后跳转到配料全程回放页面

---

### 场景2：配置配料回放（溯源回放）

#### 步骤1：编辑配料回放项目

1. 登录后台管理系统
2. 进入"配料回放项目管理"
3. 点击"编辑"某个配料回放项目
4. 在页面中找到"小程序地址"字段
5. 点击"复制地址"按钮

**生成的地址示例：**
```
/pages/ingredientreplay/videos?id=10
```

#### 步骤2：配置到商品

1. 进入"商品管理" → "商品列表"
2. 编辑需要关联的商品
3. 在"溯源回放地址"字段中粘贴地址
4. 保存商品

#### 步骤3：验证

1. 打开小程序商品详情页
2. 应该看到"溯源回放"入口
3. 点击后跳转到溯源回放页面

---

## 🧪 测试验证

### 测试步骤

#### 1. 测试溯源商品地址生成

```
访问：http://localhost:8080/xSZaYJEibq.php
→ 溯源商品管理
→ 编辑 ID=5 的溯源商品
→ 查看"小程序地址"字段
→ 应该显示：/pages/index/sycpvideo?id=5
→ 点击"复制地址"
→ 应该提示"地址已复制到剪贴板"
```

#### 2. 测试配料回放项目地址生成

```
访问：http://localhost:8080/xSZaYJEibq.php
→ 配料回放项目管理
→ 编辑 ID=10 的配料回放项目
→ 查看"小程序地址"字段
→ 应该显示：/pages/ingredientreplay/videos?id=10
→ 点击"复制地址"
→ 应该提示"地址已复制到剪贴板"
```

#### 3. 测试完整流程

```
1. 复制溯源商品地址
2. 粘贴到商品管理的"溯源回放地址"字段
3. 保存商品
4. 打开小程序商品详情页
5. 验证是否显示溯源回放入口
6. 点击入口，验证是否正确跳转
```

---

## ⚠️ 注意事项

### 1. ID 的重要性

- 地址中的 ID 是自动从当前编辑的记录中获取的
- 确保编辑的是正确的记录
- 新添加的记录需要先保存才能生成正确的 ID

### 2. 地址格式

- 生成的地址是只读的，不能手动修改
- 地址格式固定，确保小程序能正确识别
- 不要修改地址格式，否则可能导致跳转失败

### 3. 复制功能兼容性

- 使用了 `document.execCommand('copy')` 方法
- 在现代浏览器中都能正常工作
- 如果复制失败，可以手动选择并复制

### 4. 配料回放 vs 配料回放项目

- **配料回放（ingredientreplay）：** 父级分类
- **配料回放项目（ingredientreplayitem）：** 具体的视频项目
- 小程序需要的是**配料回放项目**的 ID
- 建议使用配料回放项目的地址

---

## 🔧 技术实现

### JavaScript 复制功能

```javascript
function copyToClipboard() {
    // 获取输入框
    var input = document.getElementById('c-miniapp-url');

    // 选中文本
    input.select();
    input.setSelectionRange(0, 99999); // For mobile devices

    try {
        // 执行复制命令
        document.execCommand('copy');

        // 显示成功提示
        Layer.msg('地址已复制到剪贴板', {icon: 1});
    } catch (err) {
        // 显示失败提示
        Layer.msg('复制失败，请手动复制', {icon: 2});
    }
}
```

### 地址生成逻辑

使用 ThinkPHP 模板语法动态生成：

```html
<!-- 溯源商品 -->
<input value="/pages/index/sycpvideo?id={$row.id}">

<!-- 配料回放项目 -->
<input value="/pages/ingredientreplay/videos?id={$row.id}">
```

---

## 📊 数据流程

```
后台编辑页面
    ↓
读取记录 ID ($row.id)
    ↓
生成小程序地址
/pages/index/sycpvideo?id={ID}
    ↓
显示在只读输入框中
    ↓
管理员点击"复制地址"
    ↓
JavaScript 执行复制
    ↓
地址复制到剪贴板
    ↓
管理员粘贴到商品管理
    ↓
保存到 fa_shop_goods.traceability_url
    ↓
小程序 API 返回该字段
    ↓
前端显示溯源回放入口
    ↓
用户点击跳转
```

---

## 🚀 后续优化建议

### 1. 添加二维码生成

在地址旁边添加二维码，方便手机扫码测试：

```html
<button type="button" class="btn btn-info" onclick="generateQRCode()">
    <i class="fa fa-qrcode"></i> 生成二维码
</button>
```

### 2. 添加预览功能

添加"预览"按钮，在新窗口中打开小程序页面：

```html
<button type="button" class="btn btn-primary" onclick="previewPage()">
    <i class="fa fa-eye"></i> 预览
</button>
```

### 3. 批量生成地址

在列表页面添加批量操作，一次性为多个记录生成地址。

### 4. 地址历史记录

记录每次生成的地址，方便追溯和管理。

---

## 📋 修改文件清单

| 文件 | 修改内容 | 行数 |
|------|---------|------|
| `traceabilitygoods/edit.html` | 添加地址生成区块和复制脚本 | +20 |
| `ingredientreplay/edit.html` | 添加地址生成区块和复制脚本 | +20 |
| `ingredientreplayitem/edit.html` | 添加地址生成区块和复制脚本 | +20 |

**总计：** 3个文件，约60行代码

---

## ✅ 验收标准

- [x] 溯源商品编辑页面显示地址生成功能
- [x] 配料回放项目编辑页面显示地址生成功能
- [x] 地址格式正确
- [x] 复制功能正常工作
- [x] 复制后显示成功提示
- [x] 地址可以粘贴到商品管理
- [x] 小程序能正确跳转

---

## 📚 相关文档

| 文档 | 说明 |
|------|------|
| `溯源回放入口-实施完成报告.md` | 完整功能实施报告 |
| `商品详情页-溯源回放入口需求文档.md` | 需求分析文档 |

---

**实施人员：** Claude Code
**实施日期：** 2026年2月5日
**文档版本：** v1.0
