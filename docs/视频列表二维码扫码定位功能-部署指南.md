# 视频列表二维码扫码定位功能 - 部署指南

## 功能概述

本功能允许管理员在后台商品管理页面生成带参数的二维码，用户扫描二维码后可以直接跳转到小程序商品详情页的指定日期和视频分类列表。

### 核心功能
- 后台生成带日期和视频分类参数的二维码
- 小程序自动定位到指定日期和视频分类
- 支持三种视频分类：商品溯源、精彩瞬间、多视角回放
- 二维码可下载保存，方便分享和打印

## 技术实现

### 前端（小程序）改动

**文件：** `cwlsuniapp/pages/goods/detail.vue`

#### 1. 新增数据属性
```javascript
data() {
  return {
    // ... 其他属性
    targetDate: null,  // 目标日期（从URL参数获取）
    targetType: null,  // 目标视频分类（从URL参数获取）
    list: ['商品溯源', '精彩瞬间', '多视角回放']  // 新增"多视角回放"
  }
}
```

#### 2. 修改onLoad方法
```javascript
onLoad(e) {
  this.id = e.id || e.goods_id || '';

  // 接收日期参数（用于二维码扫码定位）
  if (e.date) {
    this.targetDate = e.date;
  }

  // 接收视频分类参数（用于二维码扫码定位）
  if (e.type !== undefined) {
    this.curNow = parseInt(e.type);
    this.targetType = parseInt(e.type);
  }

  // ... 其他代码
}
```

#### 3. 修改getDateList方法
```javascript
getDateList(date){
  this.$api.getdateList({ date:date }).then(res => {
    this.datearr = res.data;

    // 如果有目标日期，自动选择对应的日期
    if (this.targetDate && this.datearr.length > 0) {
      const targetIndex = this.datearr.findIndex(item => item.riqi === this.targetDate);
      if (targetIndex !== -1) {
        this.riindex = targetIndex;
        // 更新年月显示
        const dateObj = new Date(this.targetDate);
        this.dy = dateObj.getFullYear() + "-" + (dateObj.getMonth() + 1);
      }
      this.targetDate = null; // 清空，避免重复触发
    }

    this.getVideoList()
  });
}
```

### 后端（管理页面）改动

**文件：** `kcbg/application/admin/view/shop/goods/edit.html`

#### 1. 新增二维码生成UI（在"溯源回放地址"字段后）
```html
<div class="form-group">
    <label class="control-label col-xs-12 col-sm-2">视频列表二维码:</label>
    <div class="col-xs-12 col-sm-8">
        <!-- 日期选择 -->
        <div class="input-group" style="margin-bottom: 10px;">
            <span class="input-group-addon">日期</span>
            <input type="date" id="qr-date" class="form-control" value="">
        </div>

        <!-- 分类选择 -->
        <div class="input-group" style="margin-bottom: 10px;">
            <span class="input-group-addon">分类</span>
            <select id="qr-type" class="form-control">
                <option value="0">商品溯源</option>
                <option value="1">精彩瞬间</option>
                <option value="2">多视角回放</option>
            </select>
        </div>

        <!-- 生成按钮 -->
        <button type="button" class="btn btn-primary" onclick="generateQRCode()">
            <i class="fa fa-qrcode"></i> 生成二维码
        </button>

        <!-- 二维码显示区域 -->
        <div id="qrcode-container" style="margin-top: 20px; display: none;">
            <div id="qrcode"></div>
            <p id="qr-url-display"></p>
            <button type="button" class="btn btn-success" onclick="downloadQRCode()">
                <i class="fa fa-download"></i> 下载二维码
            </button>
        </div>
    </div>
</div>
```

#### 2. 引入qrcode.js库
```html
<!-- ���入 qrcode.js 库 -->
<script src="/assets/js/qrcode.min.js"></script>
```

#### 3. 实现二维码生成和下载功能
```javascript
var qrcodeInstance = null;

function generateQRCode() {
    var goodsId = '{$row.id}';
    if (!goodsId) {
        Layer.msg('商品ID不存在，请先保存商品', {icon: 2});
        return;
    }

    var date = document.getElementById('qr-date').value;
    var type = document.getElementById('qr-type').value;

    if (!date) {
        Layer.msg('请选择日期', {icon: 2});
        return;
    }

    // 构建小程序路径
    var url = '/pages/goods/detail?id=' + goodsId;
    if (date) url += '&date=' + date;
    if (type !== null && type !== '') url += '&type=' + type;

    // 显示路径
    document.getElementById('qr-url-display').textContent = '小程序路径：' + url;

    // 清空旧的二维码
    document.getElementById('qrcode').innerHTML = '';

    // 生成新的二维码
    qrcodeInstance = new QRCode(document.getElementById('qrcode'), {
        text: url,
        width: 256,
        height: 256,
        colorDark: '#000000',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.M
    });

    // 显示二维码容器
    document.getElementById('qrcode-container').style.display = 'block';

    Layer.msg('二维码生成成功', {icon: 1});
}

function downloadQRCode() {
    var canvas = document.querySelector('#qrcode canvas');
    var img = document.querySelector('#qrcode img');

    if (!canvas && !img) {
        Layer.msg('请先生成二维码', {icon: 2});
        return;
    }

    // 如果是img标签，创建canvas
    if (!canvas && img) {
        canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        var ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
    }

    if (canvas) {
        // 获取参数用于文件名
        var goodsId = '{$row.id}';
        var date = document.getElementById('qr-date').value;
        var type = document.getElementById('qr-type').value;
        var typeNames = ['商品溯源', '精彩瞬间', '多视角回放'];
        var fileName = 'qrcode-' + goodsId + '-' + date + '-' + typeNames[type] + '.png';

        // 转换为blob并下载
        canvas.toBlob(function(blob) {
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            Layer.msg('二维码下载成功', {icon: 1});
        });
    }
}
```

## 部署步骤

### 1. 小程序端部署

小程序端的改动已经通过git提交（commit: ac375f6），部署步骤：

```bash
# 1. 拉取最新代码
cd /path/to/project
git pull origin main

# 2. 重新编译小程序
# 使用HBuilderX或命令行工具重新编译cwlsuniapp目录

# 3. 上传到微信小程序后台
# 通过HBuilderX或微信开发者工具上传
```

### 2. 后端部署

后端文件由于git配置问题未能提交，需要手动部署：

#### 步骤1：上传qrcode.min.js库

```bash
# 将qrcode.min.js文件上传到服务器
scp /path/to/qrcode.min.js user@server:/path/to/kcbg/public/assets/js/

# 或者在服务器上直接下载
cd /path/to/kcbg/public/assets/js/
curl -o qrcode.min.js https://unpkg.com/qrcodejs2@0.0.2/qrcode.min.js

# 验证文件
ls -lh qrcode.min.js
# 应该显示约19KB的文件
```

#### 步骤2：更新edit.html文件

需要手动编辑 `kcbg/application/admin/view/shop/goods/edit.html` 文件：

1. 在"溯源回放地址"字段后（约第217行后）添加二维码生成UI代码（见上文"新增二维码生成UI"部分）

2. 在文件末尾的 `{include}` 标签后添加：
   - qrcode.js库引用
   - 二维码生成和下载JavaScript代码（见上文"实现二维码生成和下载功能"部分）

#### 步骤3：清除缓存

```bash
# 清除ThinkPHP缓存
cd /path/to/kcbg
rm -rf runtime/cache/*
rm -rf runtime/temp/*

# 如果使用了opcache，重启PHP-FPM
systemctl restart php-fpm
# 或
service php-fpm restart
```

### 3. 验证部署

#### 前端验证
1. 打开小程序，访问任意商品详情页
2. 在浏览器地址栏添加参数：`?date=2024-01-15&type=0`
3. 检查页面是否自动定位到指定日期和视频分类

#### 后端验证
1. 登录后台管理系统
2. 进入商品管理 > 编辑商品页面
3. 找到"视频列表二维码"区域
4. 选择日期和分类，点击"生成二维码"
5. 检查是否成功生成二维码
6. 点击"下载二维码"，检查是否能正常下载

## 使用说明

### 管理员操作流程

1. **登录后台**
   - 访问后台管理系统
   - 进入"商品管理"模块

2. **编辑商品**
   - 选择要生成二维码的商品
   - 点击"编辑"按钮

3. **生成二维码**
   - 滚动到"视频列表二维码"区域
   - 选择目标日期（如：2024-01-15）
   - 选择视频分类（商品溯源/精彩瞬间/多视角回放）
   - 点击"生成二维码"按钮

4. **下载二维码**
   - 二维码生成后会显示在页面上
   - 显示小程序路径供参考
   - 点击"下载二维码"按钮保存图片
   - 文件名格式：`qrcode-{商品ID}-{日期}-{分类}.png`

5. **分享二维码**
   - 将下载的二维码图片用于：
     - 打印到产品包装上
     - 分享到社交媒体
     - 制作宣传海报
     - 发送给客户

### 用户使用流程

1. **扫描二维码**
   - 使用微信扫一扫功能
   - 扫描商品上的二维码

2. **自动跳转**
   - 小程序自动打开
   - 跳转到对应商品详情页
   - 自动定位到指定日期
   - 自动切换到指定视频分类

3. **查看视频**
   - 页面显示指定日期的视频列表
   - 视频分类已自动切换
   - 点击"点击回放"观看视频

## URL参数说明

### 参数格式
```
/pages/goods/detail?id={商品ID}&date={日期}&type={分类}
```

### 参数详解
- `id`: 商品ID（必填）
- `date`: 日期，格式：YYYY-MM-DD（可选）
  - 示例：`2024-01-15`
- `type`: 视频分类（可选）
  - `0`: 商品溯源
  - `1`: 精彩瞬间
  - `2`: 多视角回放

### 示例URL
```
# 只指定商品ID
/pages/goods/detail?id=123

# 指定商品ID和日期
/pages/goods/detail?id=123&date=2024-01-15

# 指定商品ID、日期和分类
/pages/goods/detail?id=123&date=2024-01-15&type=0

# 只指定商品ID和分类
/pages/goods/detail?id=123&type=1
```

## 故障排查

### 问题1：二维码无法生成

**症状：** 点击"生成二维码"按钮后没有反应或报错

**可能原因：**
1. qrcode.min.js文件未正确加载
2. 商品ID不存在
3. 未选择日期

**解决方案：**
```bash
# 1. 检查qrcode.min.js文件是否存在
ls -lh /path/to/kcbg/public/assets/js/qrcode.min.js

# 2. 检查浏览器控制台是否有JavaScript错误
# 打开浏览器开发者工具 > Console标签

# 3. 确保商品已保存（有ID）
# 4. 确保选择了日期
```

### 问题2：扫码后无法定位到指定日期

**症状：** 扫码后跳转到商品详情页，但没有自动定位到指定日期

**可能原因：**
1. 小程序代码未更新
2. 指定的日期在数据库中不存在
3. URL参数格式错误

**解决方案：**
```bash
# 1. 确认小程序已重新编译和上传
# 2. 检查数据库中是否有该日期的数据
# 3. 检查URL参数格式是否正确（YYYY-MM-DD）
```

### 问题3：二维码无法下载

**症状：** 点击"下载二维码"按钮后没有反应

**可能原因：**
1. 浏览器阻止了下载
2. Canvas转换失败

**解决方案：**
1. 检查浏览器是否阻止了弹出窗口/下载
2. 尝试右键点击二维码图片 > 另存为
3. 使用截图工具保存二维码

### 问题4：CDN加载失败

**症状：** 控制台显示 `QRCode is not defined` 错误

**解决方案：**
```bash
# 确认使用的是本地文件而不是CDN
# 检查edit.html中的script标签：
<script src="/assets/js/qrcode.min.js"></script>

# 而不是：
<script src="https://cdn.jsdelivr.net/npm/qrcodejs2@0.0.2/qrcode.min.js"></script>
```

## 技术细节

### 二维码生成原理
- 使用qrcodejs2库生成二维码
- 二维码内容为小程序路径（非完整URL）
- 微信扫码时会自动识别小程序路径并打开

### 参数传递流程
1. 后台生成带参数的小程序路径
2. 路径编码到二维码中
3. 用户扫码，微信解析路径
4. 小程序onLoad方法接收参数
5. 根据参数自动定位日期和分类

### 性能优化
- qrcode.min.js文件已本地化，避免CDN依赖
- 二维码生成在客户端完成，不占用服务器资源
- 使用Canvas进行图片转换，性能优秀

## 相关文档

- [商品详情页-展示逻辑分析.md](./商品详情页-展示逻辑分析.md)
- [视频列表二维码生成方案.md](./视频列表二维码生成方案.md)
- [视频列表二维码功能-实施完成报告.md](./视频列表二维码功能-实施完成报告.md)

## 更新日志

### 2024-02-06
- ✅ 实现小程序端URL参数接收和自动定位功能
- ✅ 实现后台二维码生成和下载功能
- ✅ 本地化qrcode.js库，解决CDN超时问题
- ✅ 新增"多视角回放"视频分类
- ✅ 优化首页文案提示

## 联系方式

如有问题，请联系开发团队。
