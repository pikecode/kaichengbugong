# 小程序支付模块修复与优化记录

> 日期：2026-02-12

## 一、支付配置修复

### 1. 微信支付签名错误修复
- **问题**：调用微信支付接口返回"签名错误，请检查后再试"
- **原因**：微信商户平台 API V2 密钥已变更，后台配置的旧密钥失效
- **修复**：���新 `kcbg/addons/epay/config.php` 中的微信支付密钥
- **影响文件**：`kcbg/addons/epay/config.php`

### 2. 生产环境关闭调试模式
- **问题**：线上 `app_debug = true`，异常信息直接暴露给用户
- **修复**：在服务器创建 `.env` 文件，设置 `debug = false`
- **影响文件**：服务器 `/www/wwwroot/cwls.turuifanxin.cn/.env`

## 二、支付流程修复

### 3. 支付回调异常处理增强
- **问题**：`verify()` 在 try-catch 外部调用，若验签抛异常会导致回调无响应，微信会持续重试
- **修复**：将 `$pay->verify()` 移入 try-catch 块内，增强错误日志记录
- **影响文件**：`kcbg/addons/shop/controller/Order.php`

### 4. 移除订单号重新生成逻辑
- **问题**：`Order::pay()` 中当支付方式变更时会重新生成 order_sn，导致微信回调携带的原订单号无法匹配，支付成功但订单状态未更新
- **修复**：移除整段 order_sn 重新生成逻辑，仅更新 paytype、method、openid 字段
- **影响文件**：`kcbg/addons/shop/model/Order.php`

### 5. 金额校验浮点精度修复
- **问题**：`settle()` 方法使用 `!=` 和 `==` 比较支付金额与订单金额，PHP 浮点运算可能导致 `19.80 != 19.80` 为 true，从而拒绝合法支付
- **修复**：改用 `bccomp($payamount, $order->saleamount, 2)` 进行精确到分的金额比较
- **影响文件**：`kcbg/addons/shop/model/Order.php`

## 三、订单页面修复

### 6. 无收货地址时页面异常修复
- **问题**：用户未设置收货地址时，订单页显示 undefined、金额为 0、商品列表为空
- **修复**：
  - 添加 v-if/v-else 判断，无地址时显示红色"请添加收货地址"提示
  - 初始化 order_info 默认值，防止模板渲染报错
  - 添加 API 请求错误处理
- **影响文件**：`cwlsuniapp/packageA/goods/order.vue`

### 7. 地址切换运费不更新修复
- **问题**：watch 条件 `val.id && !oldVal.id` 仅在首次选择地址时触发，切换地址不会重新计算运费
- **修复**：改为 `val && val.id`，任何地址变化都触发运费重算；无地址时手动调用 reCalculate 加载商品信息
- **影响文件**：`cwlsuniapp/packageA/goods/order.vue`

## 四、运费计算修复

### 8. 运费模板字段映射错误修复
- **问题**：API 返回 "Undefined index: first_price"，因为 Freight 主表字段为 `price`/`num`，而 FreightItems 代码中访问 `first_price`/`first_num`
- **修复**：在 `numPostage()` 和 `weightPostage()` 方法中，当使用主表数据时进行字段映射
- **影响文件**：`kcbg/addons/shop/model/FreightItems.php`

## 五、涉及文件汇总

| 文件 | 修改类型 |
|------|----------|
| `kcbg/addons/epay/config.php` | 更新支付密钥 |
| `kcbg/addons/shop/controller/Order.php` | 回调异常处理 |
| `kcbg/addons/shop/model/Order.php` | 移除订单号重生成、浮点精度修复 |
| `kcbg/addons/shop/model/FreightItems.php` | 运费字段映射 |
| `cwlsuniapp/packageA/goods/order.vue` | 无地址处理、地址切换修复 |
| 服务器 `.env` | 关闭调试模式 |
