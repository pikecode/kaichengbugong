# 多视角回放功能 - 部署指南

## 📋 文档信息

- **功能名称：** 商品详情页 - 多视角回放 Tab
- **创建日期：** 2026年2月5日
- **文档版本：** v1.0
- **相关文档：** `docs/商品详情页-溯源视频功能分析.md`

---

## 🎯 功能概述

在商品详情页的视频回放功能中，新增第三个 Tab "多视角回放"，与现有的"商品溯源"和"精彩瞬间"并列。

### 功能特点

- 复用现有架构，代码改动最小
- 支持按日期筛选多视角视频
- 视频数据结构与现有功能保持一致
- 后台管理系统自动支持新类型

---

## 📝 修改清单

### 1. 前端文件修改

**文件：** `cwlsuniapp/pages/goods/detail.vue`

**修改位置：** line 414

**修改内容：**

```javascript
// 修改前
list: ['商品溯源', '精彩瞬间'],

// 修改后
list: ['商品溯源', '精彩瞬间', '多视角回放'],
```

**说明：**
- 添加第三个 tab 标签
- 其他逻辑无需修改，自动支持 type=2
- `curNow` 变量会自动处理 0、1、2 三个值

---

### 2. 后端模型修改

**文件：** `kcbg/application/admin/model/shop/Video.php`

**修改位置：** line 34-37

**修改内容：**

```php
// 修改前
public function getTypeList()
{
    return ['0' => __('Type 0'), '1' => __('Type 1')];
}

// 修改后
public function getTypeList()
{
    return ['0' => __('商品溯源'), '1' => __('精彩瞬间'), '2' => __('多视角回放')];
}
```

**说明：**
- 更新类型列表，添加 type=2
- 后台管理系统会自动显示中文名称
- 便于后台人员管理视频数据

---

### 3. 数据库表结构修改

**表名：** `fa_shop_video`

**修改字段：** `type`

**SQL 语句：**

```sql
-- 修改 type 字段，支持值 '2'
ALTER TABLE `fa_shop_video`
MODIFY COLUMN `type` SET('0','1','2') DEFAULT '0'
COMMENT '视频类型：0=商品溯源，1=精彩瞬间，2=多视角回放';
```

**修改前：**
```sql
type SET('0','1') DEFAULT '0'
```

**修改后：**
```sql
type SET('0','1','2') DEFAULT '0'
```

**说明：**
- 原字段类型为 SET，只能存储 0 和 1
- 修改后支持存储 0、1、2 三个值
- 保持向后兼容，不影响现有数据

---

## 🚀 部署步骤

### 步骤 1：备份数据

```bash
# 备份数据库
mysqldump -h127.0.0.1 -uroot -p cwls > backup_cwls_$(date +%Y%m%d_%H%M%S).sql

# 备份代码文件
cp cwlsuniapp/pages/goods/detail.vue cwlsuniapp/pages/goods/detail.vue.bak
cp kcbg/application/admin/model/shop/Video.php kcbg/application/admin/model/shop/Video.php.bak
```

---

### 步骤 2：修改数据库表结构

```bash
# 连接数据库
mysql -h127.0.0.1 -uroot -p cwls

# 执行 SQL
ALTER TABLE `fa_shop_video`
MODIFY COLUMN `type` SET('0','1','2') DEFAULT '0'
COMMENT '视频类型：0=商品溯源，1=精彩瞬间，2=多视角回放';

# 验证修改
DESCRIBE fa_shop_video;

# 退出
exit;
```

**预期结果：**
```
Field: type
Type: set('0','1','2')
Default: 0
```

---

### 步骤 3：修改前端代码

**文件：** `cwlsuniapp/pages/goods/detail.vue`

找到 line 414，修改：

```javascript
list: ['商品溯源', '精彩瞬间', '多视角回放'],
```

---

### 步骤 4：修改后端代码

**文件：** `kcbg/application/admin/model/shop/Video.php`

找到 line 34-37，修改：

```php
public function getTypeList()
{
    return ['0' => __('商品溯源'), '1' => __('精彩瞬间'), '2' => __('多视角回放')];
}
```

---

### 步骤 5：清理缓存

```bash
# 清理 ThinkPHP 缓存
cd /path/to/kcbg
rm -rf runtime/cache/*
rm -rf runtime/temp/*

# 如果使用了 Redis 缓存
redis-cli FLUSHDB
```

---

### 步骤 6：重启服务

```bash
# 停止 PHP 服务
./stop-server.sh

# 启动 PHP 服务
./start-server.sh
```

---

### 步骤 7：添加测试数据（可选）

```sql
-- 插入测试数据
INSERT INTO `fa_shop_video` (
    `shop_goods_id`,
    `riqi`,
    `type`,
    `tag`,
    `title`,
    `video_url`,
    `shichang`,
    `s_time`,
    `e_time`,
    `liangdian`,
    `status`,
    `createtime`
) VALUES
(
    1,
    CURDATE(),
    '2',
    '俯视角',
    '生产线俯视全景',
    'https://www.w3school.com.cn/example/html5/mov_bbb.mp4',
    '00:02:30',
    '08:00',
    '08:30',
    '从上方俯瞰整个生产线，全面展示生产流程',
    '1',
    UNIX_TIMESTAMP()
);

-- 验证数据
SELECT id, shop_goods_id, riqi, type, tag, title, status
FROM fa_shop_video
WHERE type = '2'
ORDER BY createtime DESC;
```

---

## ✅ 功能验证

### 1. 后端 API 测试

```bash
# 测试获取多视角回放视频列表
curl "http://your-domain.com/index.php/addons/shop/api.goods/getVideoList?date=2026-02-05&type=2&goods_id=1"
```

**预期返回：**

```json
{
    "code": 1,
    "msg": "获取成功",
    "data": [
        {
            "id": 40,
            "shop_goods_id": 1,
            "type": "2",
            "tag": "俯视角",
            "title": "生产线俯视全景",
            "video_url": "https://...",
            "shichang": "00:02:30",
            "s_time": "08:00",
            "e_time": "08:30",
            "liangdian": "从上方俯瞰整个生产线...",
            "status": "1"
        }
    ]
}
```

---

### 2. 前端功能测试

**测试步骤：**

1. 打开小程序商品详情页
2. 查看视频回放区域
3. 应该看到三个 Tab：
   - 商品溯源
   - 精彩瞬间
   - **多视角回放** ⭐

4. 点击"多视角回放" Tab
5. 选择有数据的日期
6. 应该显示对应的视频列表
7. 点击"点击回放"按钮
8. 视频应该正常播放

**验证点：**

- ✅ Tab 切换正常
- ✅ 日期选择正常
- ✅ 视频列表显示正常
- ✅ 视频播放正常
- ✅ 数据加载提示正常
- ✅ 空数据提示正常

---

### 3. 后台管理测试

**测试步骤：**

1. 登录后台管理系统
2. 找到"视频管理"菜单
3. 添加新视频
4. type 字段应该有三个选项：
   - 商品溯源
   - 精彩瞬间
   - **多视角回放** ⭐

5. 选择"多视角回放"
6. 填写其他信息并保存
7. 验证数据保存成功

---

## 🔄 数据流向

```
用户操作
    ↓
点击"多视角回放" Tab
    ↓
curNow = 2
    ↓
调用 getVideoList()
    ↓
API 请求：/api.goods/getVideoList
参数：{
    date: "2026-02-05",
    type: 2,
    goods_id: 1
}
    ↓
后端查询：
SELECT * FROM fa_shop_video
WHERE riqi = '2026-02-05'
  AND type = '2'
  AND shop_goods_id = 1
  AND status = '1'
    ↓
返回视频列表
    ↓
前端渲染视频卡片
    ↓
用户点击"点击回放"
    ↓
跳转到视频播放页面
```

---

## ⚠️ 注意事项

### 1. 数据库字段类型

- `type` 字段必须是 `SET('0','1','2')` 类型
- 如果是 `ENUM` 或 `TINYINT` 类型，需要相应调整
- 确保字段支持存储字符串 '2'

### 2. 视频数据准备

- 部署后需要添加实际的视频数据
- 视频 URL 必须是可访问的地址
- 建议使用 CDN 加速视频加载

### 3. 缓存清理

- 修改代码后必须清理缓存
- 包括 ThinkPHP 缓存和浏览器缓存
- 小程序需要重新编译上传

### 4. 兼容性

- 此修改向后兼容
- 不影响现有的"商品溯源"和"精彩瞬间"功能
- 旧数据无需迁移

---

## 🔙 回滚方案

如果部署后出现问题，可以按以下步骤回滚：

### 1. 恢复数据库

```sql
-- 回滚表结构
ALTER TABLE `fa_shop_video`
MODIFY COLUMN `type` SET('0','1') DEFAULT '0';

-- 删除测试数据（如果需要）
DELETE FROM fa_shop_video WHERE type = '2';
```

### 2. 恢复代码文件

```bash
# 恢复前端文件
cp cwlsuniapp/pages/goods/detail.vue.bak cwlsuniapp/pages/goods/detail.vue

# 恢复后端文件
cp kcbg/application/admin/model/shop/Video.php.bak kcbg/application/admin/model/shop/Video.php
```

### 3. 清理缓存并重启

```bash
rm -rf kcbg/runtime/cache/*
./stop-server.sh
./start-server.sh
```

---

## 📊 性能影响

### 数据库查询

- 查询条件增加了 `type = '2'` 过滤
- 建议在 `type` 字段上添加索引（如果数据量大）

```sql
-- 添加索引（可选）
ALTER TABLE `fa_shop_video`
ADD INDEX `idx_type_riqi_goods` (`type`, `riqi`, `shop_goods_id`);
```

### 前端性能

- Tab 数量从 2 个增加到 3 个
- 对性能影响可忽略不计
- 视频列表渲染逻辑不变

---

## 📚 相关文档

| 文档 | 说明 |
|------|------|
| `docs/商品详情页-溯源视频功能分析.md` | 原有功能详细分析 |
| `SERVER-GUIDE.md` | 服务器部署和管理指南 |
| `add-multi-angle-video-test-data.sql` | 测试数据 SQL 脚本 |

---

## 🆘 常见问题

### Q1: Tab 显示不出来？

**A:** 检查以下几点：
1. 前端代码是否正确修改
2. 小程序是否重新编译上传
3. 浏览器缓存是否清理

### Q2: 点击"多视角回放"没有数据？

**A:** 检查以下几点：
1. 数据库中是否有 type='2' 的数据
2. 数据的 status 是否为 '1'（启用状态）
3. 数据的 riqi 和 shop_goods_id 是否匹配

### Q3: 后台管理看不到"多视角回放"选项？

**A:** 检查以下几点：
1. 后端模型代码是否正确修改
2. 缓存是否清理
3. 浏览器是否刷新

### Q4: 数据库修改失败？

**A:** 可能原因：
1. 表中已有 type 值不在 ('0','1') 范围内
2. 数据库权限不足
3. 表被锁定

**解决方法：**
```sql
-- 检查异常数据
SELECT DISTINCT type FROM fa_shop_video;

-- 清理异常数据
UPDATE fa_shop_video SET type = '0' WHERE type NOT IN ('0','1');

-- 再次执行修改
ALTER TABLE `fa_shop_video` MODIFY COLUMN `type` SET('0','1','2') DEFAULT '0';
```

---

## 📈 后续优化建议

### 1. 视角标签优化

可以为多视角视频添加更详细的视角分类：

```sql
-- 添加视角字段（可选）
ALTER TABLE `fa_shop_video`
ADD COLUMN `angle` VARCHAR(50) DEFAULT NULL COMMENT '视角类型：top=俯视，side=侧视，close=特写'
AFTER `tag`;
```

### 2. 视频封面图

为每个视频添加封面图，提升用户体验：

```sql
-- image 字段已存在，确保使用
UPDATE fa_shop_video
SET image = 'https://example.com/cover.jpg'
WHERE type = '2' AND image IS NULL;
```

### 3. 视频排序

支持自定义视频显示顺序：

```sql
-- 添加排序字段（可选）
ALTER TABLE `fa_shop_video`
ADD COLUMN `sort` INT DEFAULT 0 COMMENT '排序权重，数字越大越靠前'
AFTER `status`;

-- 修改查询逻辑
-- 在 Goods.php 的 getVideoList 方法中添加：
// ->order('sort', 'desc')
```

---

## 🔐 安全检查

### 1. 权限验证

- ✅ API 接口已在 `$noNeedLogin` 中配置
- ✅ 视频 URL 使用 HTTPS 协议
- ✅ 数据库查询使用参数绑定，防止 SQL 注入

### 2. 数据验证

```php
// 建议在 getVideoList 方法中添加参数验证
$type = $this->request->get('type', 0);
if (!in_array($type, [0, 1, 2])) {
    $this->error('参数错误');
}
```

---

## 📅 更新记录

| 日期 | 版本 | 说明 | 修改人 |
|------|------|------|--------|
| 2026-02-05 | v1.0 | 初始版本，完整部署指南 | Claude Code |

---

**文档维护者：** Claude Code
**最后更新：** 2026年2月5日
**联系方式：** 参考项目 README

---

## ✅ 部署检查清单

部署前请确认以下事项：

- [ ] 已备份数据库
- [ ] 已备份代码文件
- [ ] 数据库表结构已修改
- [ ] 前端代码已修改
- [ ] 后端代码已修改
- [ ] 缓存已清理
- [ ] 服务已重启
- [ ] API 接口测试通过
- [ ] 前端功能测试通过
- [ ] 后台管理测试通过
- [ ] 已添加测试数据
- [ ] 已验证回滚方案

**部署完成后，请在此处签名确认：**

```
部署人员：__________
部署日期：__________
部署环境：__________ (开发/测试/生产)
验证结果：__________ (通过/失败)
```
