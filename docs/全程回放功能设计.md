# 全程回放功能设计文档

## 一、需求分析

### 1.1 功能定位
参考"溯源产品"的设计逻辑，新增"全程回放"栏目，展示在小程序首页"溯源产品"下方。

### 1.2 与溯源产品的对比

| 维度 | 溯源产品 | 全程回放 |
|------|---------|---------|
| **定位** | 商品溯源，展示生产过程 | 完整回放，展示全流程记录 |
| **层级** | 分类 → 商品 → 视频 | 分类 → 回放 → 视频 |
| **视频类型** | 直播回放 + 精彩片段 | 完整回放 + 关键节点 |
| **使用场景** | 查看商品溯源信息 | 查看完整生产/加工流程 |

## 二、数据库设计

### 2.1 表结构设计（3张表）

#### **fa_fullreplay（全程回放分类表）**
```sql
CREATE TABLE `fa_fullreplay` (
  `id` int NOT NULL AUTO_INCREMENT,
  `title` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT '回放分类名称',
  `image` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT '缩略图',
  `images` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT '预览图',
  `description` text CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci COMMENT '分类描述',
  `weigh` int NOT NULL DEFAULT '1' COMMENT '排序',
  `createtime` bigint unsigned DEFAULT NULL COMMENT '创建时间',
  `updatetime` bigint unsigned DEFAULT NULL COMMENT '更新时间',
  `deletetime` bigint DEFAULT NULL COMMENT '删除时间',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci ROW_FORMAT=DYNAMIC COMMENT='全程回放分类';
```

#### **fa_fullreplayitem（全程回放项目表）**
```sql
CREATE TABLE `fa_fullreplayitem` (
  `id` int NOT NULL AUTO_INCREMENT,
  `fullreplay_id` int DEFAULT NULL COMMENT '回放分类id',
  `title` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT '回放项目标题',
  `image` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT '缩略图',
  `description` text CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci COMMENT '项目描述',
  `weigh` int NOT NULL DEFAULT '1' COMMENT '排序',
  `createtime` bigint unsigned DEFAULT NULL COMMENT '创建时间',
  `updatetime` bigint unsigned DEFAULT NULL COMMENT '更新时间',
  `deletetime` bigint DEFAULT NULL COMMENT '删除时间',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci ROW_FORMAT=DYNAMIC COMMENT='全程回放项目';
```

#### **fa_fullreplayitemvideo（全程回放视频表）**
```sql
CREATE TABLE `fa_fullreplayitemvideo` (
  `id` int NOT NULL AUTO_INCREMENT,
  `fullreplayitem_id` int DEFAULT NULL COMMENT '回放项目id',
  `video_url` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '视频路径',
  `image` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '缩略图',
  `type` set('0','1') CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT '0' COMMENT '类型:0=完整回放,1=关键节点',
  `title` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '标题',
  `tag` varchar(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '视频标签',
  `shijian` varchar(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '视频时间',
  `riqi` date DEFAULT NULL COMMENT '视频日期',
  `shichang` varchar(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '视频时长',
  `liangdian` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '视频亮点',
  `status` enum('0','1') CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT '1' COMMENT '是否发布:0=未发布,1=发布',
  `admin_id` int DEFAULT NULL COMMENT '创建人',
  `createtime` int DEFAULT NULL COMMENT '创建时间',
  `s_time` varchar(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '开始时间',
  `e_time` varchar(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '结束时间',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC COMMENT='全程回放视频';
```

### 2.2 表关系
```
fa_fullreplay (回放分类)
    ↓ 1对多
fa_fullreplayitem (回放项目)
    ↓ 1对多
fa_fullreplayitemvideo (回放视频)
```

## 三、后端开发

### 3.1 需要创建的文件

#### **后台管理控制器（3个）**
1. `kcbg/application/admin/controller/Fullreplay.php`
2. `kcbg/application/admin/controller/Fullreplayitem.php`
3. `kcbg/application/admin/controller/Fullreplayitemvideo.php`

#### **后台模型（3个）**
1. `kcbg/application/admin/model/Fullreplay.php`
2. `kcbg/application/admin/model/Fullreplayitem.php`
3. `kcbg/application/admin/model/Fullreplayitemvideo.php`

#### **后台验证器（3个）**
1. `kcbg/application/admin/validate/Fullreplay.php`
2. `kcbg/application/admin/validate/Fullreplayitem.php`
3. `kcbg/application/admin/validate/Fullreplayitemvideo.php`

#### **后台语言包（3个）**
1. `kcbg/application/admin/lang/zh-cn/fullreplay.php`
2. `kcbg/application/admin/lang/zh-cn/fullreplayitem.php`
3. `kcbg/application/admin/lang/zh-cn/fullreplayitemvideo.php`

#### **前端API接口（修改1个）**
- `kcbg/addons/shop/controller/api/Goods.php` - 添加3个方法：
  - `getFullReplayInfo()` - 获取回放分类详情
  - `getFullReplayItem()` - 获取回放项目列表
  - `getFullReplayItemVideoList()` - 获取回放视频列表

### 3.2 API接口设计

#### **接口1：获取回放分类详情**
```
GET /addons/shop/api.goods/getFullReplayInfo
参数：id (回放分类ID)
返回：回放分类信息（含预览图数组）
```

#### **接口2：获取回放项目列表**
```
GET /addons/shop/api.goods/getFullReplayItem
参数：fullreplay_id (回放分类ID)
返回：该分类下的所有回放项目
```

#### **接口3：获取回放视频列表**
```
GET /addons/shop/api.goods/getFullReplayItemVideoList
参数：
  - fullreplayitem_id (回放项目ID)
  - type (0=完整回放, 1=关键节点)
返回：该项目的视频列表（已发布的）
```

## 四、前端开发（小程序）

### 4.1 需要修改/创建的文件

#### **API配置（修改1个）**
- `cwlsuniapp/common/http.api.js` - 添加3个API方法

#### **页面文件（创建3个）**
1. `cwlsuniapp/pages/fullreplay/list.vue` - 回放分类列表
2. `cwlsuniapp/pages/fullreplay/items.vue` - 回放项目列表
3. `cwlsuniapp/pages/fullreplay/videos.vue` - 回放视频列表

#### **首页修改（修改1个）**
- `cwlsuniapp/pages/index/index.vue` - 添加"全程回放"入口

### 4.2 页面路由配置
在 `pages.json` 中添加：
```json
{
  "path": "pages/fullreplay/list",
  "style": {
    "navigationBarTitleText": "全程回放"
  }
},
{
  "path": "pages/fullreplay/items",
  "style": {
    "navigationBarTitleText": "回放项目"
  }
},
{
  "path": "pages/fullreplay/videos",
  "style": {
    "navigationBarTitleText": "视频回放"
  }
}
```

## 五、实施步骤

### 阶段1：数据库准备
1. 创建3张数据表
2. 插入测试数据

### 阶段2：后端开发
1. 创建后台管理控制器、模型、验证器
2. 创建语言包
3. 在API控制器中添加3个接口方法

### 阶段3：前端开发
1. 在 http.api.js 中添加API方法
2. 创建3个页面组件
3. 修改首页，添加"全程回放"入口
4. 配置页面路由

### 阶段4：测试验证
1. 后台管理功能测试
2. 小程序页面展示测试
3. API接口联调测试

## 六、预期效果

### 6.1 后台管理
- 管理员可以创建回放分类（如"生产车间"、"质检流程"）
- 为每个分类添加回放项目（如"2024年1月生产记录"）
- 为每个项目上传视频（完整回放或关键节点）

### 6.2 小程序展示
- 首页显示"全程回放"入口（在"溯源产品"下方）
- 用户点击进入，查看回放分类列表
- 选择分类，查看该分类下的回放项目
- 点击项目，观看完整回放或关键节点视频

## 七、开发时间估算

| 阶段 | 工作内容 | 预计时间 |
|------|---------|---------|
| 数据库 | 创建表结构 | 30分钟 |
| 后端 | 控制器+模型+验证器 | 2小时 |
| 后端 | API接口开发 | 1小时 |
| 前端 | API配置 | 15分钟 |
| 前端 | 页面开发 | 3小时 |
| 测试 | 功能测试 | 1小时 |
| **总计** | | **约7.75小时** |

---

**准备好开始实施了吗？我可以按照这个设计逐步帮你完成开发。**
