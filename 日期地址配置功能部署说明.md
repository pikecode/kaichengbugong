# 日期地址配置功能部署说明

## 📋 功能概述

为商品增加"日期地址配置"功能，允许为不同日期配置不同的小程序页面地址。用户在商品详情页选择日期后，点击"配料回放"tab，会显示该日期对应的入口按钮，点击跳转到配置的地址。

---

## ✅ 已完成的修改

### 1. 数据库变更

**SQL脚本：** `database_update_date_urls.sql`

```sql
ALTER TABLE fa_shop_goods
ADD COLUMN `date_urls` TEXT COMMENT '日期地址映射JSON'
AFTER `traceability_url`;
```

**数据格式示例：**
```json
{
    "2026-02-06": "/pages/ingredientreplay/videos?id=10",
    "2026-02-07": "/packageA/goods/detail?id=20"
}
```

### 2. 后台管理改动

**文件：** `kcbg/application/admin/view/shop/goods/edit.html`

**新增功能：**
- 商品编辑页面增加"日期地址配置"模块
- 支持动态添加/删除日期-地址对
- 自动将数据转换为JSON格式存储

**界面展示：**
```
┌─────────────────────────────────────────┐
│ 日期地址配置                             │
├─────────────────────────────────────────┤
│ 日期           地址                操作  │
│ 2026-02-06  /pages/ingredient...  删除  │
│ 2026-02-07  /packageA/goods...    删除  │
│ [+ 添加日期地址]                        │
└─────────────────────────────────────────┘
```

### 3. 小程序前端改动

**文件：** `cwlsuniapp/packageA/goods/detail.vue`

**修改内容：**

#### 3.1 新增计算属性 `currentDateUrl`
```javascript
computed: {
    currentDateUrl() {
        if (!this.info.date_urls || !this.datearr[this.riindex]) {
            return null;
        }
        try {
            const selectedDate = this.datearr[this.riindex].riqi;
            const dateUrls = JSON.parse(this.info.date_urls);
            return dateUrls[selectedDate] || null;
        } catch (e) {
            return null;
        }
    }
}
```

#### 3.2 修改 `sectionChange` 方法
```javascript
sectionChange(index) {
    this.curNow = index;
    if (index !== 3) {
        this.getVideoList();
    }
    // 如果是配料回放tab，显示入口按钮（不再自动跳转）
}
```

#### 3.3 新增跳转方法
```javascript
goDateUrl() {
    if (this.currentDateUrl) {
        this.goPage(this.currentDateUrl);
    }
}
```

#### 3.4 UI改动
- "配料回放"tab内容区域显示入口按钮（当有配置地址时）
- 入口按钮显示当前选中的日期
- 未配置地址时显示提示文案

---

## 📊 功能流程图

```
┌──────────────────────────────────────────────────┐
│               后台管理系统                        │
│                                                  │
│  商品管理 → 编辑商品                              │
│     ↓                                            │
│  日期地址配置                                     │
│     - 添加：2026-02-06 → /pages/ingredient...    │
│     - 添加：2026-02-07 → /packageA/goods...      │
│     ↓                                            │
│  保存（转为JSON存入 date_urls 字段）               │
└──────────────────────────────────────────────────┘
                       ↓
              数据库存储 (date_urls)
                       ↓
┌──────────────────────────────────────────────────┐
│               小程序前端                          │
│                                                  │
│  商品详情页                                       │
│     ↓                                            │
│  用户选择日期：2026-02-06                         │
│     ↓                                            │
│  点击"配料回放"tab                                 │
│     ↓                                            │
│  computed 自动计算 currentDateUrl                 │
│     ↓                                            │
│  显示入口按钮："查看本日配料回放"                   │
│     ↓                                            │
│  用户点击按钮                                     │
│     ↓                                            │
│  跳转到：/pages/ingredientreplay/videos?id=10    │
│     ↓                                            │
│  路由拦截器转换                                    │
│     ↓                                            │
│  /packageC/ingredientreplay/videos?id=10         │
└──────────────────────────────────────────────────┘
```

---

## 🚀 部署步骤

### 第1步：执行数据库脚本 ✅ 完成

```bash
# 已执行完成
# 执行时间：2026-02-06
# 执行用户：cwls
# 数据库：cwls

ALTER TABLE fa_shop_goods ADD COLUMN `date_urls` TEXT COMMENT '日期地址映射JSON' AFTER `traceability_url`;

# 验证结果：
# Field      Type    Null    Key     Default    Extra
# date_urls  text    YES             NULL
```

### 第2步：后台文件已部署 ✅ 完成

- ✅ 后台文件已备份到 `/backup/20260206/goods_edit.html.bak`
- ✅ 新文件已部署到 `application/admin/view/shop/goods/edit.html`
- ✅ 缓存已清理

### 第3步：小程序前端部署 ⚠️ 待执行

**需要操作：**
1. 编译小程序
2. 上传微信开发者工具
3. 提交审核
4. 审核通过后发布

---

## 📝 使用指南

### 后台配置步骤：

1. 登录后台管理系统
2. 进入商品管理 → 编辑商品
3. 找到"日期地址配置"模块
4. 点击"添加日期地址"按钮
5. 输入日期（格式：2026-02-06）
6. 输入小程序页面地址（任意小程序页面均可）
7. 点击确定
8. 保存商品

### 前端使用流程：

1. 用户打开商品详情页
2. 选择日期（例如：2026-02-06）
3. 点击"配料回放"tab
4. 如果该日期有配置地址，显示入口按钮
5. 点击入口按钮，跳转到配置的地址
6. 如果该日期没有配置地址，显示提示"当前日期暂无配料回放内容"

---

## ⚠️ 重要说明

### 1. 与原有功能的关系

**原有字段：** `traceability_url`（溯源回放地址）
- 功能：存储固定的溯源回放地址
- 用途：商品详情页"配料回放"标签点击跳转（已废弃）

**新增字段：** `date_urls`（日期地址映射）
- 功能：为不同日期配置不同的地址
- 优先级：新功能优先于旧功能
- 兼容性：如果没有配置日期地址，会显示提示

### 2. 地址格式说明

**支持的地址类型：**
- 配料回放：`/pages/ingredientreplay/videos?id=10`
- 溯源商品：`/pages/index/sycpvideo?id=8`
- 商品详情：`/packageA/goods/detail?id=5`
- 任意其他小程序页面

**路径转换：**
- 前端路由拦截器会自动处理 `/pages/` → `/packageC/` 等路径转换
- 后台配置时使用旧路径即可，无需担心分包问题

### 3. 数据兼容性

- ✅ 旧商品（未配置 date_urls）：显示提示，不影响正常使用
- ✅ 新商品（配置了 date_urls）：正常显示入口按钮
- ✅ 混合情况（部分日期有配置）：有配置显示按钮，无配置显示提示

---

## 🧪 测试步骤

### 1. 后台测试

```
1. 登录后台管理
2. 商品管理 → 编辑任意商品
3. 找到"日期地址配置"模块
4. 点击"添加日期地址"
5. 输入日期：2026-02-06
6. 输入地址：/pages/ingredientreplay/videos?id=10
7. 确认后查看是否显示在列表中
8. 保存商品
9. 刷新页面，检查配置是否保留
```

### 2. 前端测试（需要小程序部署后）

```
1. 打开商品详情页
2. 选择日期：2026-02-06
3. 点击"配料回放"tab
4. 检查是否显示入口按钮
5. 按钮上是否显示正确的日期
6. 点击按钮，检查是否跳转到正确页面
7. 切换到其他日期（未配置的日期）
8. 检查是否显示提示文案
```

---

## 🔙 回滚方案

如果部署出现问题：

```bash
# 恢复后台文件
cp /backup/20260206/goods_edit.html.bak \
   /www/wwwroot/cwls.turuifanxin.cn/application/admin/view/shop/goods/edit.html

# 清理缓存
cd /www/wwwroot/cwls.turuifanxin.cn/runtime/
rm -rf cache/* temp/*

# 数据库回滚（如果需要）
ALTER TABLE fa_shop_goods DROP COLUMN `date_urls`;
```

---

## 📋 部署检查清单

**数据库层：**
- [x] 执行SQL脚本，添加 date_urls 字段
- [x] 验证字段是否添加成功

**后台管理：**
- [x] 后台文件已备份
- [x] 后台文件已部署
- [x] 缓存已清理
- [x] 数据库字段已添加，可以登录后台测试配置功能

**前端小程序：**
- [ ] 编译小程序
- [ ] 上传微信开发者工具
- [ ] 提交审核
- [ ] 审核通过后发布
- [ ] 测试日期地址跳转功能

**完整测试：**
- [ ] 后台配置日期地址
- [ ] 小程序选择日期
- [ ] 点击配料回放tab
- [ ] 检查入口按钮显示
- [ ] 点击跳转验证

---

**部署日期：** 2026-02-06
**部署状态：** ✅ 后台已部署，✅ 数据库已执行，⏳ 小程序待部署
**版本号：** v1.4.0（日期地址配置功能）
