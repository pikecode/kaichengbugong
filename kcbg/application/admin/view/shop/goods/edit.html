<form id="edit-form" class="form-horizontal" role="form" data-toggle="validator" method="POST" action="">


    <div class="panel panel-default panel-intro">
        <div class="panel-heading">
            <ul class="nav nav-tabs nav-group">
                <li class="active"><a href="#basics" data-toggle="tab">åŸºç¡€ä¿¡æ¯</a></li>
                <li><a href="#skus" data-toggle="tab">è§„æ ¼ä¿¡æ¯</a></li>
            </ul>
        </div>
        <div class="panel-body">
            <div id="myTabContent" class="tab-content">
                <div class="tab-pane fade active in" id="basics">
                    <div class="form-group">
                        <label class="control-label col-xs-12 col-sm-2">{:__('Category')}:</label>
                        <div class="col-xs-12 col-sm-8">
                            <input id="c-category_id" data-rule="required"
                                data-source="shop/category/index/noKeyField/100" class="form-control selectpage"
                                data-format-item="{spacer} {name}" name="row[category_id]" type="text"
                                value="{$row.category_id|htmlentities}">
                        </div>
                    </div>
                    <div id="attributes"></div>
                    <div class="form-group">
                        <label class="control-label col-xs-12 col-sm-2">{:__('Brand')}:</label>
                        <div class="col-xs-12 col-sm-8">
                            <input id="c-brand_id" data-source="shop/brand/index" class="form-control selectpage"
                                name="row[brand_id]" type="text" value="{$row.brand_id|htmlentities}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-xs-12 col-sm-2">{:__('Title')}:</label>
                        <div class="col-xs-12 col-sm-8">
                            <input id="c-title" data-rule="required" class="form-control" name="row[title]" type="text"
                                value="{$row.title|htmlentities}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-xs-12 col-sm-2">{:__('Goods_sn')}:</label>
                        <div class="col-xs-12 col-sm-8">
                            <input id="c-goods_sn" class="form-control" name="row[goods_sn]" type="text"
                                value="{$row.goods_sn|htmlentities}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-xs-12 col-sm-2">{:__('Subtitle')}:</label>
                        <div class="col-xs-12 col-sm-8">
                            <input id="c-subtitle" data-rule="" class="form-control" name="row[subtitle]" type="text"
                                value="{$row.subtitle|htmlentities}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-xs-12 col-sm-2">{:__('Keywords')}:</label>
                        <div class="col-xs-12 col-sm-8">
                            <input id="c-keywords" class="form-control" name="row[keywords]" type="text"
                                value="{$row.keywords|htmlentities}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-xs-12 col-sm-2">{:__('Description')}:</label>
                        <div class="col-xs-12 col-sm-8">
                            <textarea id="c-description" class="form-control" cols="10" rows="5"
                                name="row[description]">{$row.description|htmlentities}</textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-xs-12 col-sm-2">{:__('Marketprice')}:</label>
                        <div class="col-xs-12 col-sm-8">
                            <input id="c-marketprice"  class="form-control" step="0.01"
                                name="row[marketprice]" type="number" value="{$row.marketprice|htmlentities}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-xs-12 col-sm-2">{:__('Price')}:</label>
                        <div class="col-xs-12 col-sm-8">
                            <input id="c-price" data-rule="required" class="form-control" step="0.01" name="row[price]"
                                type="number" value="{$row.price|htmlentities}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-xs-12 col-sm-2">{:__('Stocks')}:</label>
                        <div class="col-xs-12 col-sm-8">
                            <input id="c-stocks" data-rule="required" class="form-control" {if
                                $row.spectype}disabled{/if} name="row[stocks]" type="number"
                                value="{$row.stocks|htmlentities}">
                            <div class="alert alert-warning-light">
                                <i class="fa fa-info-circle"></i> æ¸©é¦¨æç¤º<br>
                                å¤šè§„æ ¼å•†å“è§„æ ¼è¯·åœ¨å•†å“åˆ—è¡¨å®Œæˆå½•å…¥<br>
                                å¤šè§„æ ¼å•†å“åº“å­˜å€¼æ— éœ€è¦ä¿®æ”¹ï¼Œè‡ªåŠ¨è®¡ç®—
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-xs-12 col-sm-2">{:__('Image')}:</label>
                        <div class="col-xs-12 col-sm-8">
                            <div class="input-group">
                                <input id="c-image" data-rule="required" class="form-control" size="50"
                                    name="row[image]" type="text" value="{$row.image|htmlentities}">
                                <div class="input-group-addon no-border no-padding">
                                    <span><button type="button" id="faupload-image" class="btn btn-danger faupload"
                                            data-input-id="c-image"
                                            data-mimetype="image/gif,image/jpeg,image/png,image/jpg,image/bmp,image/webp"
                                            data-multiple="false" data-preview-id="p-image"><i class="fa fa-upload"></i>
                                            {:__('Upload')}</button></span>
                                    <span><button type="button" id="fachoose-image" class="btn btn-primary fachoose"
                                            data-input-id="c-image" data-mimetype="image/*" data-multiple="false"><i
                                                class="fa fa-list"></i> {:__('Choose')}</button></span>
                                </div>
                                <span class="msg-box n-right" for="c-image"></span>
                            </div>
                            <ul class="row list-inline faupload-preview" id="p-image"></ul>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-xs-12 col-sm-2">{:__('Images')}:</label>
                        <div class="col-xs-12 col-sm-8">
                            <div class="input-group">
                                <input id="c-images" data-rule="required" class="form-control" size="50"
                                    name="row[images]" type="text" value="{$row.images|htmlentities}">
                                <div class="input-group-addon no-border no-padding">
                                    <span><button type="button" id="faupload-images" class="btn btn-danger faupload"
                                            data-input-id="c-images"
                                            data-multiple="true" data-preview-id="p-images"><i class="fa fa-upload"></i>
                                            {:__('Upload')}</button></span>
                                    <span><button type="button" id="fachoose-images" class="btn btn-primary fachoose"
                                            data-input-id="c-images" data-mimetype="image/*" data-multiple="true"><i
                                                class="fa fa-list"></i> {:__('Choose')}</button></span>
                                </div>
                                <span class="msg-box n-right" for="c-images"></span>
                            </div>
                            <ul class="row list-inline faupload-preview" id="p-images"></ul>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-xs-12 col-sm-2">{:__('Content')}:</label>
                        <div class="col-xs-12 col-sm-8">
                            <textarea id="c-content" class="form-control editor" rows="5" name="row[content]"
                                cols="50">{$row.content|htmlentities}</textarea>
                            <!-- <div style="margin-top:5px;">
                                <a href="javascript:" class="btn btn-xs btn-success btn-card">{:__('æ’å…¥å¡ç‰‡')}</a>
                            </div> -->
                        </div>
                    </div>
<!--                    <div class="form-group">-->
<!--                        <label class="control-label col-xs-12 col-sm-2">{:__('Corner')}:</label>-->
<!--                        <div class="col-xs-12 col-sm-8">-->
<!--                            <input id="c-corner" class="form-control" name="row[corner]" type="text"-->
<!--                                value="{$row.corner|htmlentities}">-->
<!--                        </div>-->
<!--                    </div>-->
                    <div class="form-group">
                        <label class="control-label col-xs-12 col-sm-2">{:__('Flag')}:</label>
                        <div class="col-xs-12 col-sm-8">

                            <select id="c-flag" class="form-control selectpicker" multiple="" name="row[flag][]">
                                {foreach name="flagList" item="vo"}
                                <option value="{$key}" {in name="key" value="$row.flag" }selected{/in}>{$vo}</option>
                                {/foreach}
                            </select>

                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-xs-12 col-sm-2">{:__('Weight')}:</label>
                        <div class="col-xs-12 col-sm-8">
                            <input id="c-weight" class="form-control" step="0.01" name="row[weight]" type="number"
                                value="{$row.weight|htmlentities}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-xs-12 col-sm-2">{:__('Freight')}:</label>
                        <div class="col-xs-12 col-sm-8">
                            <input id="c-freight_id" data-rule="required" data-source="shop/freight/index"
                                class="form-control selectpage" name="row[freight_id]" type="text"
                                value="{$row.freight_id|htmlentities}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-xs-12 col-sm-2">{:__('Guarantee')}:</label>
                        <div class="col-xs-12 col-sm-8">
                            <input id="c-guarantee_ids" data-source="shop/guarantee/index" data-multiple="true"
                                class="form-control selectpage" name="row[guarantee_ids]" type="text"
                                value="{$row.guarantee_ids|htmlentities}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-xs-12 col-sm-2">{:__('Weigh')}:</label>
                        <div class="col-xs-12 col-sm-8">
                            <input id="c-weigh" data-rule="required" class="form-control" name="row[weigh]"
                                type="number" value="{$row.weigh|htmlentities}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-xs-12 col-sm-2">{:__('Status')}:</label>
                        <div class="col-xs-12 col-sm-8">

                            <div class="radio">
                                {foreach name="statusList" item="vo"}
                                <label for="row[status]-{$key}"><input id="row[status]-{$key}" name="row[status]"
                                        type="radio" value="{$key}" {in name="key" value="$row.status" }checked{/in} />
                                    {$vo}</label>
                                {/foreach}
                            </div>

                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-xs-12 col-sm-2">æº¯æºå›æ”¾åœ°å€:</label>
                        <div class="col-xs-12 col-sm-8">
                            <input id="c-traceability_url" class="form-control" name="row[traceability_url]" type="text"
                                value="{$row.traceability_url|htmlentities}" placeholder="ç²˜è´´æº¯æºå•†å“æˆ–é…æ–™å›æ”¾ç”Ÿæˆçš„åœ°å€">
                            <span class="help-block">
                                ç¤ºä¾‹ï¼š/pages/index/sycpvideo?id=5 æˆ– /pages/ingredientreplay/videos?id=10<br>
                                ç•™ç©ºåˆ™ä¸æ˜¾ç¤ºæº¯æºå›æ”¾å…¥å£
                            </span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-xs-12 col-sm-2">æ—¥æœŸåœ°å€é…ç½®:</label>
                        <div class="col-xs-12 col-sm-8">
                            <div id="date-url-list" style="margin-bottom: 10px;">
                                <!-- åŠ¨æ€ç”Ÿæˆçš„æ—¥æœŸåœ°å€åˆ—è¡¨ -->
                            </div>
                            <button type="button" class="btn btn-success btn-sm" onclick="addDateUrl()">
                                <i class="fa fa-plus"></i> æ·»åŠ æ—¥æœŸåœ°å€
                            </button>
                            <input type="hidden" name="row[date_urls]" id="date-urls-input" value="{$row.date_urls|htmlentities}">
                            <span class="help-block">
                                ä¸ºä¸åŒæ—¥æœŸé…ç½®ä¸åŒçš„å°ç¨‹åºé¡µé¢åœ°å€ï¼Œç”¨æˆ·åœ¨å•†å“è¯¦æƒ…é¡µé€‰æ‹©æ—¥æœŸåï¼Œç‚¹å‡»"é…æ–™å›æ”¾"tabå¯è·³è½¬åˆ°å¯¹åº”åœ°å€<br>
                                åœ°å€å¯ä»¥æ˜¯ä»»æ„å°ç¨‹åºé¡µé¢ï¼Œå¦‚ï¼š/pages/ingredientreplay/videos?id=10
                            </span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-xs-12 col-sm-2">è§†é¢‘åˆ—è¡¨äºŒç»´ç :</label>
                        <div class="col-xs-12 col-sm-8">
                            <!-- æ—¥æœŸé€‰æ‹© -->
                            <div class="input-group" style="margin-bottom: 10px;">
                                <span class="input-group-addon">æ—¥æœŸ</span>
                                <input type="date" id="qr-date" class="form-control" value="">
                            </div>

                            <!-- åˆ†ç±»é€‰æ‹© -->
                            <div class="input-group" style="margin-bottom: 10px;">
                                <span class="input-group-addon">åˆ†ç±»</span>
                                <select id="qr-type" class="form-control">
                                    <option value="0">ç”Ÿäº§å…¨ç¨‹å›æ”¾</option>
                                    <option value="1">ç²¾å½©ç¬é—´</option>
                                    <option value="2">å¤šè§†è§’å›æ”¾</option>
                                    <option value="3">é…æ–™å›æ”¾</option>
                                </select>
                            </div>

                            <!-- ç¯å¢ƒé€‰æ‹© -->
                            <div class="input-group" style="margin-bottom: 10px;">
                                <span class="input-group-addon">ç¯å¢ƒ</span>
                                <select id="qr-env" class="form-control">
                                    <option value="release">æ­£å¼ç‰ˆ</option>
                                    <option value="trial" selected>ä½“éªŒç‰ˆï¼ˆæµ‹è¯•ç”¨ï¼‰</option>
                                    <option value="develop">å¼€å‘ç‰ˆ</option>
                                </select>
                            </div>

                            <!-- ç”ŸæˆæŒ‰é’® -->
                            <button type="button" class="btn btn-primary" onclick="generateQRCode()">
                                <i class="fa fa-qrcode"></i> ç”ŸæˆäºŒç»´ç 
                            </button>

                            <!-- äºŒç»´ç æ˜¾ç¤ºåŒºåŸŸ -->
                            <div id="qrcode-container" style="margin-top: 20px; display: none;">
                                <div id="qrcode" style="text-align: center; padding: 20px; background: #f5f5f5; border-radius: 5px;"></div>
                                <div style="text-align: center; margin-top: 10px;">
                                    <p id="qr-url-display" style="word-break: break-all; color: #666; font-size: 12px;"></p>
                                    <button type="button" class="btn btn-success" onclick="downloadQRCode()">
                                        <i class="fa fa-download"></i> ä¸‹è½½äºŒç»´ç 
                                    </button>
                                </div>
                            </div>

                            <span class="help-block">
                                ç”ŸæˆäºŒç»´ç åï¼Œç”¨æˆ·æ‰«ç å¯ç›´æ¥è·³è½¬åˆ°æŒ‡å®šæ—¥æœŸå’Œåˆ†ç±»çš„è§†é¢‘åˆ—è¡¨
                            </span>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="skus">
                    {include file="shop/goods/add_sku" /}
                </div>

            </div>
        </div>
    </div>

    <div id="goods-sku"></div>

    <div class="form-group layer-footer">
        <label class="control-label col-xs-12 col-sm-2"></label>
        <div class="col-xs-12 col-sm-8">
            <button type="submit" class="btn btn-primary btn-embossed disabled">{:__('OK')}</button>
            <button type="reset" class="btn btn-default btn-embossed">{:__('Reset')}</button>
        </div>
    </div>
</form>

{include file="shop/goods/attributetpl" /}
{include file="shop/common/cardtpl" /}

<!-- å¼•å…¥ qrcode.js åº“ -->
<script src="/assets/js/qrcode.min.js"></script>

<script>
// äºŒç»´ç ç”ŸæˆåŠŸèƒ½
var qrcodeInstance = null;

// æ—¥æœŸåœ°å€é…ç½®ç›¸å…³
var dateUrlsData = {};

// åˆå§‹åŒ–æ—¥æœŸåœ°å€åˆ—è¡¨
function initDateUrls() {
    var dateUrlsInput = document.getElementById('date-urls-input');
    if (dateUrlsInput && dateUrlsInput.value && dateUrlsInput.value !== '') {
        try {
            var parsed = JSON.parse(dateUrlsInput.value);
            if (typeof parsed === 'object' && parsed !== null) {
                dateUrlsData = parsed;
            } else {
                dateUrlsData = {};
            }
        } catch (e) {
            console.error('è§£ææ—¥æœŸåœ°å€æ•°æ®å¤±è´¥:', e);
            dateUrlsData = {};
        }
    } else {
        dateUrlsData = {};
    }
    renderDateUrlList();
}

// æ·»åŠ æ—¥æœŸåœ°å€
function addDateUrl() {
    Layer.open({
        type: 1,
        title: 'æ·»åŠ æ—¥æœŸåœ°å€',
        area: ['600px', '400px'],
        content: '<div style="padding: 20px;">' +
                 '<div class="form-group">' +
                 '    <label>é€‰æ‹©æ—¥æœŸï¼š</label>' +
                 '    <input type="date" id="date-picker-add" class="form-control" />' +
                 '</div>' +
                 '<div class="form-group">' +
                 '    <label>å°ç¨‹åºé¡µé¢åœ°å€ï¼š</label>' +
                 '    <input type="text" id="url-input-add" class="form-control" placeholder="/pages/ingredientreplay/videos?id=10" />' +
                 '    <span class="help-block">å¯ä»¥æ˜¯ä»»æ„å°ç¨‹åºé¡µé¢ï¼Œå¦‚ï¼š/pages/ingredientreplay/videos?id=10</span>' +
                 '</div>' +
                 '</div>',
        btn: ['ç¡®å®š', 'å–æ¶ˆ'],
        yes: function(index) {
            var date = document.getElementById('date-picker-add').value;
            var url = document.getElementById('url-input-add').value;

            // éªŒè¯æ—¥æœŸ
            if (!date) {
                Layer.msg('è¯·é€‰æ‹©æ—¥æœŸ', {icon: 2});
                return;
            }

            // éªŒè¯åœ°å€
            if (!url) {
                Layer.msg('åœ°å€ä¸èƒ½ä¸ºç©º', {icon: 2});
                return;
            }

            // æ£€æŸ¥æ—¥æœŸæ˜¯å¦å·²å­˜åœ¨
            if (dateUrlsData[date]) {
                Layer.confirm('è¯¥æ—¥æœŸå·²å­˜åœ¨é…ç½®ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ', function(idx) {
                    dateUrlsData[date] = url;
                    updateDateUrlsInput();
                    renderDateUrlList();
                    Layer.close(idx);
                    Layer.close(index);
                    Layer.msg('æ·»åŠ æˆåŠŸ', {icon: 1});
                });
            } else {
                // æ·»åŠ åˆ°æ•°æ®
                dateUrlsData[date] = url;
                updateDateUrlsInput();
                renderDateUrlList();
                Layer.close(index);
                Layer.msg('æ·»åŠ æˆåŠŸ', {icon: 1});
            }
        }
    });
}

// ç¼–è¾‘æ—¥æœŸåœ°å€
function editDateUrl(date) {
    var currentUrl = dateUrlsData[date];

    Layer.open({
        type: 1,
        title: 'ç¼–è¾‘æ—¥æœŸåœ°å€',
        area: ['600px', '400px'],
        content: '<div style="padding: 20px;">' +
                 '<div class="form-group">' +
                 '    <label>æ—¥æœŸï¼š</label>' +
                 '    <input type="date" id="date-picker-edit" class="form-control" value="' + date + '" />' +
                 '</div>' +
                 '<div class="form-group">' +
                 '    <label>å°ç¨‹åºé¡µé¢åœ°å€ï¼š</label>' +
                 '    <input type="text" id="url-input-edit" class="form-control" value="' + currentUrl + '" placeholder="/pages/ingredientreplay/videos?id=10" />' +
                 '    <span class="help-block">å¯ä»¥æ˜¯ä»»æ„å°ç¨‹åºé¡µé¢ï¼Œå¦‚ï¼š/pages/ingredientreplay/videos?id=10</span>' +
                 '</div>' +
                 '</div>',
        btn: ['ä¿å­˜', 'å–æ¶ˆ'],
        yes: function(index) {
            var newDate = document.getElementById('date-picker-edit').value;
            var newUrl = document.getElementById('url-input-edit').value;

            // éªŒè¯æ—¥æœŸ
            if (!newDate) {
                Layer.msg('è¯·é€‰æ‹©æ—¥æœŸ', {icon: 2});
                return;
            }

            // éªŒè¯åœ°å€
            if (!newUrl) {
                Layer.msg('åœ°å€ä¸èƒ½ä¸ºç©º', {icon: 2});
                return;
            }

            // å¦‚æœæ—¥æœŸæ”¹å˜äº†ï¼Œéœ€è¦åˆ é™¤æ—§çš„
            if (newDate !== date) {
                delete dateUrlsData[date];
            }

            // æ›´æ–°æ•°æ®
            dateUrlsData[newDate] = newUrl;
            updateDateUrlsInput();
            renderDateUrlList();
            Layer.close(index);
            Layer.msg('ç¼–è¾‘æˆåŠŸ', {icon: 1});
        }
    });
}

// åˆ é™¤æ—¥æœŸåœ°å€
function removeDateUrl(date) {
    Layer.confirm('ç¡®å®šè¦åˆ é™¤è¯¥æ—¥æœŸåœ°å€é…ç½®å—ï¼Ÿ', function(index) {
        delete dateUrlsData[date];
        updateDateUrlsInput();
        renderDateUrlList();
        Layer.close(index);
        Layer.msg('åˆ é™¤æˆåŠŸ', {icon: 1});
    });
}

// æ›´æ–°éšè—å­—æ®µ
function updateDateUrlsInput() {
    document.getElementById('date-urls-input').value = JSON.stringify(dateUrlsData);
}

// æ¸²æŸ“æ—¥æœŸåœ°å€åˆ—è¡¨
function renderDateUrlList() {
    var listHtml = '';
    var dates = Object.keys(dateUrlsData).sort();

    if (dates.length === 0) {
        listHtml = '<div class="alert alert-info">æš‚æ— æ—¥æœŸåœ°å€é…ç½®</div>';
    } else {
        listHtml = '<table class="table table-bordered table-hover">';
        listHtml += '<thead><tr><th width="150">æ—¥æœŸ</th><th>å°ç¨‹åºåœ°å€</th><th width="150">æ“ä½œ</th></tr></thead>';
        listHtml += '<tbody>';

        dates.forEach(function(date) {
            listHtml += '<tr>';
            listHtml += '<td>' + date + '</td>';
            listHtml += '<td style="word-break: break-all;">' + dateUrlsData[date] + '</td>';
            listHtml += '<td>';
            listHtml += '<button type="button" class="btn btn-primary btn-xs" onclick="editDateUrl(\'' + date + '\')" style="margin-right: 5px;"><i class="fa fa-edit"></i> ç¼–è¾‘</button>';
            listHtml += '<button type="button" class="btn btn-danger btn-xs" onclick="removeDateUrl(\'' + date + '\')"><i class="fa fa-trash"></i> åˆ é™¤</button>';
            listHtml += '</td>';
            listHtml += '</tr>';
        });

        listHtml += '</tbody></table>';
    }

    document.getElementById('date-url-list').innerHTML = listHtml;
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ– - ä½¿ç”¨åŸç”ŸJavaScriptï¼Œé¿å…jQueryä¾èµ–
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        initDateUrls();
    });
} else {
    // DOMå·²ç»åŠ è½½å®Œæˆ
    initDateUrls();
}

function generateQRCode() {
    // è·å–å•†å“IDï¼ˆä»URLæˆ–è¡¨å•ï¼‰
    var goodsId = '{$row.id}';
    if (!goodsId) {
        Layer.msg('å•†å“IDä¸å­˜åœ¨ï¼Œè¯·å…ˆä¿å­˜å•†å“', {icon: 2});
        return;
    }

    // è·å–é€‰æ‹©çš„æ—¥æœŸå’Œåˆ†ç±»
    var date = document.getElementById('qr-date').value;
    var type = document.getElementById('qr-type').value;
    var env = document.getElementById('qr-env').value;

    // éªŒè¯æ—¥æœŸæ˜¯å¦é€‰æ‹©
    if (!date) {
        Layer.msg('è¯·é€‰æ‹©æ—¥æœŸ', {icon: 2});
        return;
    }

    // æ„å»ºå°ç¨‹åºé¡µé¢è·¯å¾„ï¼ˆä½¿ç”¨åˆ†åŒ…è·¯å¾„ï¼‰
    var page = 'packageA/goods/detail';

    // å°†æ—¥æœŸæ ¼å¼ä» 2026-02-12 è½¬æ¢ä¸º 20260212ï¼ˆèŠ‚çœ2ä¸ªå­—ç¬¦ï¼Œæ»¡è¶³32å­—ç¬¦é™åˆ¶ï¼‰
    var shortDate = date.replace(/-/g, '');

    // æ„å»ºsceneå‚æ•°ï¼ˆå°ç¨‹åºç çš„å‚æ•°ï¼Œæœ€å¤š32ä¸ªå­—ç¬¦ï¼‰
    // ä¾‹å¦‚ï¼šid=39&date=20260212&type=0 = 26å­—ç¬¦
    var scene = 'id=' + goodsId + '&date=' + shortDate + '&type=' + type;

    // URLç¼–ç  scene å‚æ•°
    var encodedScene = encodeURIComponent(scene);
    var debugPath = page + '?scene=' + encodedScene;

    // æ˜¾ç¤ºURLä¿¡æ¯
    var envText = env === 'release' ? 'æ­£å¼ç‰ˆ' : (env === 'trial' ? 'ä½“éªŒç‰ˆ' : 'å¼€å‘ç‰ˆ');
    document.getElementById('qr-url-display').textContent = 'ç¯å¢ƒï¼š' + envText + ' | å°ç¨‹åºè·¯å¾„ï¼š/' + page + ' | å‚æ•°ï¼š' + scene;

    // æ¸…ç©ºä¹‹å‰çš„äºŒç»´ç 
    document.getElementById('qrcode').innerHTML = '<div style="text-align:center;padding:50px;">æ­£åœ¨ç”ŸæˆäºŒç»´ç ...</div>';
    document.getElementById('qrcode-container').style.display = 'block';

    // è°ƒç”¨åç«¯æ¥å£ï¼Œä½¿ç”¨å¾®ä¿¡ createQRCode API ç”Ÿæˆæ ‡å‡†æ–¹å½¢äºŒç»´ç 
    $.ajax({
        url: 'shop/ajax/create_qr_code',
        type: 'POST',
        dataType: 'json',
        data: {
            page: page,
            scene: scene,
            env_version: env
        },
        success: function(res) {
            if (res.code === 1) {
                // ç”ŸæˆæˆåŠŸï¼Œæ˜¾ç¤ºäºŒç»´ç å›¾ç‰‡
                var html = '<div style="text-align:center;padding:20px;background:#fff;border-radius:8px;">';
                html += '<img src="' + res.data + '?' + Date.now() + '" style="width:280px;" />';
                html += '</div>';
                html += '<div style="margin-top:20px;padding:15px;background:#f0f9ff;border:1px solid #0ea5e9;border-radius:5px;">';
                html += '<div style="font-weight:bold;color:#0369a1;margin-bottom:10px;">ğŸ“± å¾®ä¿¡å¼€å‘è€…å·¥å…·è°ƒè¯•è·¯å¾„ï¼š</div>';
                html += '<div style="background:white;padding:10px;border-radius:3px;word-break:break-all;font-family:monospace;font-size:12px;color:#1e293b;">';
                html += debugPath;
                html += '</div>';
                html += '<button type="button" class="btn btn-sm btn-info" style="margin-top:10px;" onclick="copyDebugPath(\'' + debugPath.replace(/'/g, "\\'") + '\')">';
                html += '<i class="fa fa-copy"></i> å¤åˆ¶è·¯å¾„';
                html += '</button>';
                html += '<div style="margin-top:10px;font-size:12px;color:#64748b;">';
                html += 'ğŸ’¡ åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·çš„"ç¼–è¯‘æ¨¡å¼"ä¸­ç²˜è´´æ­¤è·¯å¾„ï¼Œå¯ç›´æ¥è°ƒè¯•æ‰«ç æ•ˆæœ';
                html += '</div>';
                html += '</div>';
                document.getElementById('qrcode').innerHTML = html;
                Layer.msg('äºŒç»´ç ç”ŸæˆæˆåŠŸ', {icon: 1});
            } else {
                document.getElementById('qrcode').innerHTML = '<div style="text-align:center;padding:50px;color:red;">ç”Ÿæˆå¤±è´¥ï¼š' + res.msg + '</div>';
                Layer.msg(res.msg, {icon: 2});
            }
        },
        error: function(xhr) {
            document.getElementById('qrcode').innerHTML = '<div style="text-align:center;padding:50px;color:red;">è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ</div>';
            Layer.msg('è¯·æ±‚å¤±è´¥', {icon: 2});
        }
    });
}

// å¤åˆ¶è°ƒè¯•è·¯å¾„åˆ°å‰ªè´´æ¿
function copyDebugPath(path) {
    // åˆ›å»ºä¸´æ—¶æ–‡æœ¬æ¡†
    var textarea = document.createElement('textarea');
    textarea.value = path;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);

    // é€‰æ‹©å¹¶å¤åˆ¶
    textarea.select();
    try {
        document.execCommand('copy');
        Layer.msg('è°ƒè¯•è·¯å¾„å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', {icon: 1});
    } catch (err) {
        Layer.msg('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', {icon: 2});
    }

    // ç§»é™¤ä¸´æ—¶å…ƒç´ 
    document.body.removeChild(textarea);
}

function downloadQRCode() {
    // è·å–äºŒç»´ç å›¾ç‰‡
    var img = document.querySelector('#qrcode img');

    if (!img || !img.src) {
        Layer.msg('è¯·å…ˆç”ŸæˆäºŒç»´ç ', {icon: 2});
        return;
    }

    // è·å–å‚æ•°ç”¨äºæ–‡ä»¶å
    var goodsId = '{$row.id}';
    var date = document.getElementById('qr-date').value;
    var type = document.getElementById('qr-type').value;
    var typeNames = ['ç”Ÿäº§å…¨ç¨‹å›æ”¾', 'ç²¾å½©ç¬é—´', 'å¤šè§†è§’å›æ”¾', 'é…æ–™å›æ”¾'];
    var fileName = 'qrcode-' + goodsId + '-' + date + '-' + typeNames[type] + '.png';

    // é€šè¿‡ fetch ä¸‹è½½åŸå§‹å›¾ç‰‡ï¼Œé¿å…è·¨åŸŸå’Œè£å‰ªé—®é¢˜
    var imgUrl = img.src.split('?')[0]; // å»æ‰ç¼“å­˜å‚æ•°
    fetch(imgUrl)
        .then(function(res) { return res.blob(); })
        .then(function(blob) {
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            Layer.msg('äºŒç»´ç ä¸‹è½½æˆåŠŸ', {icon: 1});
        })
        .catch(function() {
            // fallback: ç›´æ¥æ‰“å¼€å›¾ç‰‡è®©ç”¨æˆ·å³é”®ä¿å­˜
            window.open(imgUrl, '_blank');
            Layer.msg('è¯·å³é”®å›¾ç‰‡å¦å­˜ä¸º', {icon: 0});
        });
}
</script>
